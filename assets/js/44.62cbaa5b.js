(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{328:function(t,s,a){"use strict";a.r(s);var n=a(10),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"gitlab-docker-git免密-cicd"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-docker-git免密-cicd"}},[t._v("#")]),t._v(" "),s("center",[t._v("gitlab(docker)+git免密+CICD")])],1),t._v(" "),s("h2",{attrs:{id:"安装gitlab"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装gitlab"}},[t._v("#")]),t._v(" 安装gitlab")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" pull gitlab/gitlab-ce\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" /docker/gitlab/etc\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" /docker/gitlab/log\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" /docker/gitlab/opt\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-R")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("777")]),t._v(" /docker/gitlab\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /docker/gitlab/\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" docker-compose.yml\n")])])]),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gitlabce")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'gitlab/gitlab-ce:latest'")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gitlabce\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostname")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gitlabce\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /docker/gitlab/etc"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/gitlab\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /docker/gitlab/log"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/log/gitlab\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /docker/gitlab/opt"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/opt/gitlab\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'9980:80'")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'9922:22'")]),t._v("\n")])])]),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker-compose")]),t._v(" up "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v("\n")])])]),s("p",[t._v("可能会花几分钟，监听一下,成功启动后开始下一步")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("watch")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v("\n")])])]),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /docker/gitlab/etc/gitlab.rb\n")])])]),s("div",{staticClass:"language-rb extra-class"},[s("pre",{pre:!0,attrs:{class:"language-rb"}},[s("code",[t._v("external_url "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://192.168.2.200'")])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 不要加端口")]),t._v("\ngitlab_rails"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'gitlab_ssh_host'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'192.168.2.200'")])]),t._v("\ngitlab_rails"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string-literal"}},[s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'gitlab_shell_ssh_port'")])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9922")]),t._v("\n")])])]),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" gitlabce /bin/bash\ngitlab-ctl reconfigure\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v("\n")])])]),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /docker/gitlab/opt/gitlab-rails/etc/gitlab.yml\n")])])]),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("host")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 192.168.2.200\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9980")]),t._v("\n")])])]),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" gitlabce /bin/bash\ngitlab-ctl restart\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v("\n")])])]),s("h3",{attrs:{id:"进入容器修改密码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#进入容器修改密码"}},[t._v("#")]),t._v(" 进入容器修改密码")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" gitlabce /bin/bash\ngitlab-rails console\n")])])]),s("p",[t._v("比较耗时,等待完成后依次输入以下语句")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("u")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("User.where"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id:1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".first\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("u.password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'614489858'")]),t._v(" // 新密码\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("u.password_confirmation")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'614489858'")]),t._v("\nu.save"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v("\n")])])]),s("p",[t._v("浏览器访问"),s("code",[t._v("http://192.168.2.200:9980/")]),t._v(",账号是"),s("code",[t._v("root")]),t._v("，密码是刚才修改的密码,也就是"),s("code",[t._v("614489858")]),t._v(".")]),t._v(" "),s("p",[t._v("自此gitlab一安装成功")]),t._v(" "),s("h2",{attrs:{id:"安装gitlab-runner-ci-cd"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装gitlab-runner-ci-cd"}},[t._v("#")]),t._v(" 安装gitlab-runner(CI/CD)")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" pull gitlab/gitlab-runner\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" /docker/gitlab-runner/config\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v("  /docker/gitlab-runner\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" docker-compose.yml\n")])])]),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("version")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'3'")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("services")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("gitlabrunner")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'gitlab/gitlab-runner:latest'")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("container_name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gitlabrunner\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("hostname")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" gitlabrunner\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("restart")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" always\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("volumes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /docker/gitlab"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner/config"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/etc/gitlab"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /var/run/docker.sock"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/var/run/docker.sock\n")])])]),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker-compose")]),t._v(" up "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v("\n")])])]),s("h3",{attrs:{id:"注册gitlab-runner"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注册gitlab-runner"}},[t._v("#")]),t._v(" 注册gitlab-runner")]),t._v(" "),s("p",[t._v("root登录gitlab,左上角点击"),s("code",[t._v("menu")]),t._v("按钮 -> 选择"),s("code",[t._v("Admin")]),t._v(" -> 点击左侧菜单"),s("code",[t._v("Runners")]),t._v(" -> 点击右上方按钮"),s("code",[t._v("Register an instance runner")]),t._v("获取token")]),t._v(" "),s("p",[t._v("zgAq_h8xeeq8xbtSMsBg")]),t._v(" "),s("p",[t._v("回到虚拟机")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--rm")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /docker/gitlab-runner/config:/etc/gitlab-runner "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\ngitlab/gitlab-runner register "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--non-interactive "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--executor")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"docker"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--docker-image alpine:latest "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--url")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://192.168.2.200:9980/"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--registration-token "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"zgAq_h8xeeq8xbtSMsBg"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--description")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"runner "')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--tag-list "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"runner"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--run-untagged"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--locked")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"false"')]),t._v("\n")])])]),s("p",[t._v("参数说明")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("--registration-token")]),t._v("是刚才在gitlab获取的token")]),t._v(" "),s("li",[s("code",[t._v("--url")]),t._v("是gitlab地址(这里是http://192.168.2.200:9980/)")])]),t._v(" "),s("p",[t._v("注册成功后刷新刚才页面可以看到")]),t._v(" "),s("h3",{attrs:{id:"配置runner挂载卷"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置runner挂载卷"}},[t._v("#")]),t._v(" 配置runner挂载卷")]),t._v(" "),s("p",[t._v("修改"),s("code",[t._v("/docker/gitlab-runner/config/config.toml")]),t._v("文件，将"),s("code",[t._v('volumes = ["/cache"]')]),t._v("改为"),s("code",[t._v('volumes = ["/cache", "/usr/bin/docker:/usr/bin/docker", "/var/run/docker.sock:/var/run/docker.sock"]')])]),t._v(" "),s("h3",{attrs:{id:"测试"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#测试"}},[t._v("#")]),t._v(" 测试")]),t._v(" "),s("p",[t._v("gitlab -> 点击左上角按钮"),s("code",[t._v("Menu")]),t._v(" -> 选择"),s("code",[t._v("Group")]),t._v(" -> 选择"),s("code",[t._v("your groups")]),t._v(" -> 点击"),s("code",[t._v("New group")]),t._v(" -> 点击"),s("code",[t._v("Create group")]),t._v("创建一个新的组")]),t._v(" "),s("h4",{attrs:{id:"新建用户"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#新建用户"}},[t._v("#")]),t._v(" 新建用户")]),t._v(" "),s("p",[t._v("gitlab -> 点击左上角按钮"),s("code",[t._v("Menu")]),t._v(" -> 选择"),s("code",[t._v("Admin")]),t._v("按钮 -> 点击左侧"),s("code",[t._v("Users")]),t._v("菜单 -> 点击右侧靠上按钮"),s("code",[t._v("New user")]),t._v("添加名为"),s("code",[t._v("kition")]),t._v("用户 -> 点击右侧考上带有icon的"),s("code",[t._v("Edit")]),t._v("按钮修改用户(添加密码)")]),t._v(" "),s("h4",{attrs:{id:"新建组并添加用户"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#新建组并添加用户"}},[t._v("#")]),t._v(" 新建组并添加用户")]),t._v(" "),s("p",[t._v("gitlab -> 点击左上角按钮"),s("code",[t._v("Menu")]),t._v(" -> 选择"),s("code",[t._v("Admin")]),t._v("按钮 -> 点击左侧"),s("code",[t._v("Groups")]),t._v("菜单 -> 创建一个新名为"),s("code",[t._v("demo")]),t._v("的测试组 -> 创建后将root用户和kition用户，角色选为开发者 -> 点击"),s("code",[t._v("Add users to group")]),t._v("按钮")]),t._v(" "),s("h4",{attrs:{id:"新建项目并添加用户组"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#新建项目并添加用户组"}},[t._v("#")]),t._v(" 新建项目并添加用户组")]),t._v(" "),s("p",[t._v("gitlab -> 点击左上角按钮"),s("code",[t._v("Menu")]),t._v(" -> 选择"),s("code",[t._v("Projects")]),t._v("按钮 -> "),s("code",[t._v("Your projects")]),t._v(" -> 点击右侧靠上按钮"),s("code",[t._v("New project")]),t._v(" -> 选择"),s("code",[t._v("Create blank project")]),t._v("创建一个空白项目 -> 输入项目名"),s("code",[t._v("demo_project")]),t._v("并点击按钮"),s("code",[t._v("Create project")]),t._v("创建 -> 选择右侧"),s("code",[t._v("Project information")]),t._v("下"),s("code",[t._v("Members")]),t._v(" -> 点击右侧"),s("code",[t._v("Invite group")]),t._v("选项卡添加"),s("code",[t._v("demo")]),t._v("组")]),t._v(" "),s("h4",{attrs:{id:"添加ssh-key"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#添加ssh-key"}},[t._v("#")]),t._v(" 添加ssh key")]),t._v(" "),s("p",[t._v("window电脑上执行,y之后就一直回车直到完成所有步骤")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /root\nssh-keygen "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-t")]),t._v(" rsa "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-C")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stu"')]),t._v("\n")])])]),s("p",[t._v("将会在"),s("code",[t._v("C:\\Users\\[用户名]\\.ssh")]),t._v("文件夹下生成"),s("code",[t._v("id_rsa")]),t._v("和"),s("code",[t._v("id_rsa.pub")]),t._v("文件，用记事本打开"),s("code",[t._v("id_rsa.pub")]),t._v("文件，复制其内容，将之粘贴到：gatlab -> 点击右上角头像 -> 选择"),s("code",[t._v("Edit profile")]),t._v(" -> 选择左侧菜单"),s("code",[t._v("SSH Keys")]),t._v(" -> "),s("code",[t._v("Key")]),t._v("下面的文本框中,点击"),s("code",[t._v("Add key")])]),t._v(" "),s("p",[t._v("gitlab -> 点击左上角按钮"),s("code",[t._v("Menu")]),t._v(" -> 选择"),s("code",[t._v("Projects")]),t._v("按钮 -> "),s("code",[t._v("Your projects")]),t._v(" -> 选择刚才的"),s("code",[t._v("demo_project")]),t._v("项目 -> 点击右侧"),s("code",[t._v("Clone")]),t._v("克隆项目")]),t._v(" "),s("h3",{attrs:{id:"编写测试代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写测试代码"}},[t._v("#")]),t._v(" 编写测试代码")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[t._v("express gitlab-demo\n")])])]),s("p",[t._v("将"),s("code",[t._v("demo_project")]),t._v("项目的"),s("code",[t._v(".git")]),t._v("文件夹拷贝到"),s("code",[t._v("gitlab-demo")]),t._v("下")]),t._v(" "),s("h4",{attrs:{id:"添加忽略文件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#添加忽略文件"}},[t._v("#")]),t._v(" 添加忽略文件")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" .gitignore\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("dist\n.DS_Store\nnode_modules\ncoverage\ntemp\nexplorations\nTODOs.md\n*.log\n.idea\n.eslintcache\ndts-build/packages\n*.tsbuildinfo\n")])])]),s("p",[t._v("随便修改下文件测试")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" routes/users.js\n")])])]),s("div",{staticClass:"language-js extra-class"},[s("pre",{pre:!0,attrs:{class:"language-js"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" express "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'express'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" router "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" express"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("Router")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("/* GET users listing. */")]),t._v("\nrouter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'respond with a resource'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nrouter"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("get")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/ping'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("req"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  res"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'i is fish'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nmodule"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("exports "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" router"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),s("h4",{attrs:{id:"编写dockerfile"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写dockerfile"}},[t._v("#")]),t._v(" 编写Dockerfile")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" Dockerfile\n")])])]),s("div",{staticClass:"language-Dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" node:16.13.0 "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" builder")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WORKDIR")]),t._v(" /app")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENV")]),t._v(" app /app")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" . .")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" npm install --legacy-peer-deps")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXPOSE")]),t._v(" 3000")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CMD")]),t._v(" npm run start")]),t._v("\n")])])]),s("h4",{attrs:{id:"编写-gitlab-ci-yml"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写-gitlab-ci-yml"}},[t._v("#")]),t._v(" 编写.gitlab-ci.yml")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" .gitlab-ci.yml\n")])])]),s("div",{staticClass:"language-yml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("alpine\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node_modules_cache\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" node_modules\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker build "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("t express"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v1.0 .\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" main\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" if "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" $(docker ps "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("aq "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("filter name=my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("express) "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("; then docker stop my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("express "),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" docker rm my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("express;fi\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker run "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("d "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p 3000"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("3000 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("name my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("express express"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v1.0\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" main\n")])])]),s("h4",{attrs:{id:"提交代码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#提交代码"}},[t._v("#")]),t._v(" 提交代码")]),t._v(" "),s("div",{staticClass:"language-sh extra-class"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" commit "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-m")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" push\n")])])]),s("h1",{attrs:{id:"老的文档"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#老的文档"}},[t._v("#")]),t._v(" ==============================================================================================================================================================================================================\n===                                                                                                                                                                                                        ===\n===                                                                                    老的文档                                                                                                             ===\n===                                                                                                                                                                                                        ===")]),t._v(" "),s("h5",{attrs:{id:"安装gitlab-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装gitlab-2"}},[t._v("#")]),t._v(" 安装gitlab")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" pull gitlab/gitlab-ce\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" gitlab "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" gitlab\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" etc\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" log\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" opt\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v("  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9980")]),t._v(":80 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9922")]),t._v(":22 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /docker/gitlab/etc:/etc/gitlab  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /docker/gitlab/log:/var/log/gitlab "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /docker/gitlab/opt:/var/opt/gitlab "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--restart")]),t._v(" always "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" gitlab "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n gitlab/gitlab-ce\n")])])]),s("h5",{attrs:{id:"修改gitlab配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#修改gitlab配置"}},[t._v("#")]),t._v(" 修改gitlab配置")]),t._v(" "),s("p",[t._v("docker安装的gitlab clone地址所以错的，并且ci/cd也有问题，所以必须修改")]),t._v(" "),s("p",[t._v("目前没找到更好的方法，只能进入docker容器修改")]),t._v(" "),s("p",[t._v("进入容器：")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" gitlab /bin/bash\n")])])]),s("p",[t._v("修改gitlab.rb文件（ external_url不要加端口）")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" /etc/gitlab/gitlab.rb\n \n "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# http clone ip 注意:不要加端口")]),t._v("\n external_url "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://192.168.2.200'")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# git clone ip")]),t._v("\n gitlab_rails"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'gitlab_ssh_host'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'192.168.2.200'")]),t._v("\n "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# git clone 端口")]),t._v("\n gitlab_rails"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'gitlab_shell_ssh_port'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9922")]),t._v("\n \n "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 是配置生效")]),t._v("\n gitlab-ctl reconfigure\n")])])]),s("p",[t._v("修改gitlab.yml")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" /var/opt/gitlab/gitlab-rails/etc/gitlab.yml\n "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ip地址")]),t._v("\n host: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("192.168")]),t._v(".2.200\n "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# http clone 端口")]),t._v("\n port: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9980")]),t._v("\n \n gitlab-ctl restart\n")])])]),s("p",[t._v("注意：一定是先修改gitlab.rb，再修改gitlab.yml。前者将覆盖后者。重启之后需要修改gitlab.yml(重启后被gitlab.rb覆盖)，再重启。不要用docker重启，进入容器内部重启")]),t._v(" "),s("h5",{attrs:{id:"root密码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#root密码"}},[t._v("#")]),t._v(" root密码")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("// 进入容器\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" gitlab /bin/bash\n\n// 查看密码"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("该密码保存24小时，所以需要修改"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" /etc/gitlab/initial_root_password \n\n// 修改root密码\ngitlab-rails console // 比较耗时,等待\n\n// 依次输入以下语句\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("u")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("User.where"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id:1"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(".first\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("u.password")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'614489858'")]),t._v(" // 新密码\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("u.password_confirmation")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'614489858'")]),t._v("\nu.save"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v("\n")])])]),s("h5",{attrs:{id:"配置免密登录"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置免密登录"}},[t._v("#")]),t._v(" 配置免密登录")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("// 生成密钥,生成的文件一般在 C:"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("Users"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("用户名"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v(".ssh 文件夹下,将id_rsa.pub复制\nssh-keygen "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-t")]),t._v(" rsa "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-C")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"admin1"')]),t._v(" // "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-c")]),t._v(" 后面是注释,密码可选\n")])])]),s("p",[t._v("访问 http://192.168.2.200:9980 (地址根据自己服务器)点击头像 -> 偏好设置 -> 右侧 ssh密钥 -> 将复制的粘贴进入文本框")]),t._v(" "),s("h5",{attrs:{id:"上传项目"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#上传项目"}},[t._v("#")]),t._v(" 上传项目")]),t._v(" "),s("p",[t._v("创建项目，成员，组省略。在http://192.168.2.200:9980/(地址根据实际情况)页面配置")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("// 添加远程链接,注意:ssh端口是9922"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("对应docker容器的22端口"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(",且不是默认端口"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("9922")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("ssh://必填 \n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" remote "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("add")]),t._v(" origin ssh://git@192.168.2.200:9922/stu/test1.git\n\n // 首次推送加上-u\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" push "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-u")]),t._v(" origin master \n")])])]),s("h5",{attrs:{id:"拉取"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#拉取"}},[t._v("#")]),t._v(" 拉取")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone ssh://git@192.168.2.200:9922/stu/test1.git\n// 注意:这里拉去的是main分支，我们提交的是master分支，记得切换分支 \n")])])]),s("h4",{attrs:{id:"ci-cd"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#ci-cd"}},[t._v("#")]),t._v(" CI/CD")]),t._v(" "),s("h5",{attrs:{id:"安装gitlab-runner"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装gitlab-runner"}},[t._v("#")]),t._v(" 安装gitlab-runner")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" pull gitlab/gitlab-runner\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" gitlab-runner/config\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" gitlab-runner "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--restart")]),t._v(" always "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /docker/gitlab-runner/config:/etc/gitlab-runner "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /var/run/docker.sock:/var/run/docker.sock "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\ngitlab/gitlab-runner\n\n注意：-v /docker/gitlab-runner/config:/etc/gitlab-runner "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v(" 这句不要改位置\n")])])]),s("h5",{attrs:{id:"注册gitlab-runner-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#注册gitlab-runner-2"}},[t._v("#")]),t._v(" 注册gitlab-runner")]),t._v(" "),s("p",[t._v("root登录gitlab，http://192.168.2.200:9980/， 管理中心(admin area) -> runner -> 右上方按钮Register an instance runner 获取token")]),t._v(" "),s("p",[t._v("--registration-token token")]),t._v(" "),s("p",[t._v("--url gitlab地址 (这里是http://192.168.2.200:9980/)")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--rm")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-v")]),t._v(" /docker/gitlab-runner/config:/etc/gitlab-runner "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\ngitlab/gitlab-runner register "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--non-interactive "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--executor")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"docker"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--docker-image alpine:latest "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--url")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://192.168.2.200:9980/"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--registration-token "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"rxd_tbJJX17u-yNrkvMg"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--description")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"runner "')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--tag-list "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"runner"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--run-untagged"),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--locked")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"false"')]),t._v("\n")])])]),s("p",[t._v("注册成功后可以在gitlab => 管理中心(admin area) -> runner 看到")]),t._v(" "),s("h5",{attrs:{id:"配置runner挂载卷-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置runner挂载卷-2"}},[t._v("#")]),t._v(" 配置runner挂载卷")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-it")]),t._v(" gitlab-runner /bin/bash\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /etc/gitlab-runner\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" config.toml\n\n/**\n将volumes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/cache"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("改为volumes "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/cache"')]),t._v(", "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/usr/bin/docker:/usr/bin/docker"')]),t._v(", "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/run/docker.sock:/var/run/docker.sock"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n*/ \n")])])]),s("h5",{attrs:{id:"编写dockerfile-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写dockerfile-2"}},[t._v("#")]),t._v(" 编写Dockerfile")]),t._v(" "),s("div",{staticClass:"language-dockerfile extra-class"},[s("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[s("code",[s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" node:latest "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("as")]),t._v(" builder")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WORKDIR")]),t._v(" /app")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ENV")]),t._v(" app /app")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" bin "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${app}")]),t._v("/bin")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" public "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${app}")]),t._v("/public")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" routes "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${app}")]),t._v("/routes")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" views "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${app}")]),t._v("/views")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" app.js "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${app}")]),t._v("/app.js")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" package-lock.json "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${app}")]),t._v("/package-lock.json")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ADD")]),t._v(" package.json "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("${app}")]),t._v("/package.json")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" npm install")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" npm install pm2")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXPOSE")]),t._v(" 3000")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token instruction"}},[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CMD")]),t._v(" npm run prd")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# vue 流程")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# FROM node:latest as builder")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# WORKDIR /app")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# ENV app /app")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# COPY . .")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# RUN npm install")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# RUN npm run build")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# FROM nginx:latest")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# COPY --from=builder /app/dist /usr/share/nginx/html")]),t._v("\n")])])]),s("h5",{attrs:{id:"编写-gitlab-ci-yml-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#编写-gitlab-ci-yml-2"}},[t._v("#")]),t._v(" 编写.gitlab-ci.yml")]),t._v(" "),s("p",[t._v("在项目根目录创建.gitlab-ci.yml文件，注意前面有个.")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("alpine\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node_modules_cache\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" node_modules\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# job_install:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   stage: install")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   tags:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#     - "runner"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   script:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - npm install")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker build "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("t express"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v1.0 .\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" master\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" if "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" $(docker ps "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("aq "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("filter name=my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("express) "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("; then docker stop my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("express "),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" docker rm my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("express;fi\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker run "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("d "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p 3000"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("3000 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("name my"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("express express"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v1.0\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" master\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# when: manual")]),t._v("\n")])])]),s("h5",{attrs:{id:"远程部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#远程部署"}},[t._v("#")]),t._v(" 远程部署")]),t._v(" "),s("p",[t._v("主要利用远程ssh")]),t._v(" "),s("p",[t._v("机器A生成一对密钥，公钥传给机器B")]),t._v(" "),s("p",[t._v("机器A操作")]),t._v(" "),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('// 添加host，免得每次写一大串\n// stu是机器A， s1是机器B\nvim /etc/hosts\n192.168.2.200 stu\n192.168.2.201 s1\n\n// 同步到机器B\nscp /etc/hosts root@s1:/etc/hosts\n\n// 生成密钥\nssh-keygen -t rsa -C "stu"\n\n// 需要改名\nscp ~/.ssh/id_rsa.pub root@s1:~/.ssh/authorized_keys\n// 机器B报错没有.ssh/文件夹则创建一个则可\n\n// 测试\nssh s1\n')])])]),s("p",[t._v("将id_rsa上传到gitlab中，设置成变量")]),t._v(" "),s("p",[t._v("主页 => 菜单 => 管理员 => 设置 => ci/cd => 变量 => 添加变量(复制id_rsa的内容放入)")]),t._v(" "),s("p",[t._v("注意:不要勾选保护变量")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# image: node:alpine")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" node"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("latest\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" install\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" deploy\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cache")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("key")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("files")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" package"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("lock.json\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("paths")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" node_modules\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("variables")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("target")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.2.201"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containerName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"my-express"')]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("imageName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"express:v1.0"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# job_install:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   stage: install")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   tags:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#     - "runner"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   script:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     # - npm install")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - echo ${containerName}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - echo ${imageName}")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_build")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker build "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("t $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("imageName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" .\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("only")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" master\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("interruptible")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 可被打断，需要gitlab设置，参见下面注释")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("job_deploy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" deploy\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("before_script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'which ssh-agent || ( yum update -y && yum install openssh-client git -y )'")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" eval $(ssh"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("agent "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("s)\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' echo "$SSH_PRIVATE_KEY" '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" tr "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("d '\\r' "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),t._v(" ssh"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("add "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mkdir "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p ~/.ssh\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" chmod 700 ~/.ssh\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ssh"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("keyscan $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" ~/.ssh/known_hosts \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" chmod 644 ~/.ssh/known_hosts\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" docker save "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("o $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("imageName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(".tar $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("imageName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" scp ./$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("imageName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(".tar root@$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("/root \n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("containerName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("imageName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ssh $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(' "if docker ps '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("aq "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("filter name=$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("containerName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("; then docker stop $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("containerName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" docker rm $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("containerName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" docker rmi $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("imageName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(';fi"\n    '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ssh $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(' "docker load '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("i $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("imageName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('.tar"\n    '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ssh $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(' "docker run '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("d "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("p 3000"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("3000 "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("name $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("containerName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("imageName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('"\n    '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" ssh $"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("target"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(' "rm '),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rf ./$"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("imageName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v('.tar"\n  '),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("timeout")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 3h 30m "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 超时时间")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# when: manual")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# # vue dist")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# job_vue_build:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   tags:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#     - "runner"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   stage: build")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   script:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     # - npm install")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     # - npm run build")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - mkdir  dist")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - touch dist/index")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - echo 'i is fish, 233' >> dist/index")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   artifacts: # 保存下来")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     paths:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#       - dist")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# job_vue_deploy:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   tags:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#     - "runner"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   stage: deploy")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   before_script:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - 'which ssh-agent || ( yum update -y && yum install openssh-client git -y )'")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - eval $(ssh-agent -s)")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - echo ${SSH_PRIVATE_KEY}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - echo \"$SSH_PRIVATE_KEY\" | tr -d '\\r' | ssh-add -")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - mkdir -p ~/.ssh")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - chmod 700 ~/.ssh")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - ssh-keyscan ${target} >> ~/.ssh/known_hosts ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - chmod 644 ~/.ssh/known_hosts")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   script:")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#     - echo "start scp"')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - scp -r dist root@${target}:/root ")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#     - ssh ${target} "touch test.txt; touch test2.txt" #执行多条语句加分号')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#     - exit ")]),t._v("\n")])])]),s("p",[t._v("注:若需要流水线可打断，须在项目 => 设置 => ci/cd => 流水线通用设置 => 勾选自动取消多于流水线")])])}),[],!1,null,null,null);s.default=e.exports}}]);