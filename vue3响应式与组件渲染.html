<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>月窗散记</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="/docs/imgs/head.jpg">
    <meta name="description" content="闲暇记录学习代码时的点滴历程">
    <meta name="keywords" content="月窗散记,笔记,开发">
    
    <link rel="preload" href="/docs/assets/css/0.styles.5d5ec1c5.css" as="style"><link rel="preload" href="/docs/assets/js/app.e9bf7062.js" as="script"><link rel="preload" href="/docs/assets/js/2.21081ec6.js" as="script"><link rel="preload" href="/docs/assets/js/1.d6a5e65b.js" as="script"><link rel="preload" href="/docs/assets/js/85.b52f4b36.js" as="script"><link rel="prefetch" href="/docs/assets/js/10.9b4db267.js"><link rel="prefetch" href="/docs/assets/js/100.e311d782.js"><link rel="prefetch" href="/docs/assets/js/101.7499b16d.js"><link rel="prefetch" href="/docs/assets/js/102.f7d7d9fc.js"><link rel="prefetch" href="/docs/assets/js/103.a41cb2e9.js"><link rel="prefetch" href="/docs/assets/js/104.ce259601.js"><link rel="prefetch" href="/docs/assets/js/105.c940ba59.js"><link rel="prefetch" href="/docs/assets/js/106.7c947769.js"><link rel="prefetch" href="/docs/assets/js/107.1a04a9d6.js"><link rel="prefetch" href="/docs/assets/js/108.30de9c83.js"><link rel="prefetch" href="/docs/assets/js/109.22a243b0.js"><link rel="prefetch" href="/docs/assets/js/11.690021fa.js"><link rel="prefetch" href="/docs/assets/js/110.d198aa34.js"><link rel="prefetch" href="/docs/assets/js/111.dcfc4fa5.js"><link rel="prefetch" href="/docs/assets/js/112.865ed45e.js"><link rel="prefetch" href="/docs/assets/js/113.61279f07.js"><link rel="prefetch" href="/docs/assets/js/114.5250c33f.js"><link rel="prefetch" href="/docs/assets/js/115.326839b0.js"><link rel="prefetch" href="/docs/assets/js/116.b1d4cbbb.js"><link rel="prefetch" href="/docs/assets/js/117.1acfbebc.js"><link rel="prefetch" href="/docs/assets/js/118.93f13cdc.js"><link rel="prefetch" href="/docs/assets/js/119.5a980eba.js"><link rel="prefetch" href="/docs/assets/js/12.6fcc671a.js"><link rel="prefetch" href="/docs/assets/js/120.fbd81856.js"><link rel="prefetch" href="/docs/assets/js/121.1b960932.js"><link rel="prefetch" href="/docs/assets/js/122.b29fb009.js"><link rel="prefetch" href="/docs/assets/js/123.63cbd0d2.js"><link rel="prefetch" href="/docs/assets/js/124.3f1d290b.js"><link rel="prefetch" href="/docs/assets/js/125.59469aaf.js"><link rel="prefetch" href="/docs/assets/js/126.b09e4266.js"><link rel="prefetch" href="/docs/assets/js/127.fc7fda67.js"><link rel="prefetch" href="/docs/assets/js/128.01e1c038.js"><link rel="prefetch" href="/docs/assets/js/129.df69bdbf.js"><link rel="prefetch" href="/docs/assets/js/13.c7a0c6d5.js"><link rel="prefetch" href="/docs/assets/js/14.2b8b9240.js"><link rel="prefetch" href="/docs/assets/js/15.20728d29.js"><link rel="prefetch" href="/docs/assets/js/16.5321a22c.js"><link rel="prefetch" href="/docs/assets/js/17.60ed3f63.js"><link rel="prefetch" href="/docs/assets/js/18.cb38b1ad.js"><link rel="prefetch" href="/docs/assets/js/19.b58682e0.js"><link rel="prefetch" href="/docs/assets/js/20.08fed5a8.js"><link rel="prefetch" href="/docs/assets/js/21.b6e62902.js"><link rel="prefetch" href="/docs/assets/js/22.24c69e91.js"><link rel="prefetch" href="/docs/assets/js/23.921f8a74.js"><link rel="prefetch" href="/docs/assets/js/24.f2152ebf.js"><link rel="prefetch" href="/docs/assets/js/25.55cb6df7.js"><link rel="prefetch" href="/docs/assets/js/26.ba83a3fb.js"><link rel="prefetch" href="/docs/assets/js/27.174b1678.js"><link rel="prefetch" href="/docs/assets/js/28.309b00b4.js"><link rel="prefetch" href="/docs/assets/js/29.b35680f8.js"><link rel="prefetch" href="/docs/assets/js/3.04f428b9.js"><link rel="prefetch" href="/docs/assets/js/30.6aaabbcf.js"><link rel="prefetch" href="/docs/assets/js/31.cc5cffb7.js"><link rel="prefetch" href="/docs/assets/js/32.ad41d324.js"><link rel="prefetch" href="/docs/assets/js/33.1140989d.js"><link rel="prefetch" href="/docs/assets/js/34.ff497298.js"><link rel="prefetch" href="/docs/assets/js/35.4d523d75.js"><link rel="prefetch" href="/docs/assets/js/36.1c20b66a.js"><link rel="prefetch" href="/docs/assets/js/37.2da1705f.js"><link rel="prefetch" href="/docs/assets/js/38.0fe1c3f1.js"><link rel="prefetch" href="/docs/assets/js/39.1f6a5c7b.js"><link rel="prefetch" href="/docs/assets/js/4.1ce2464c.js"><link rel="prefetch" href="/docs/assets/js/40.eddd46af.js"><link rel="prefetch" href="/docs/assets/js/41.42a73812.js"><link rel="prefetch" href="/docs/assets/js/42.43955417.js"><link rel="prefetch" href="/docs/assets/js/43.bd3ec667.js"><link rel="prefetch" href="/docs/assets/js/44.62cbaa5b.js"><link rel="prefetch" href="/docs/assets/js/45.233edbc3.js"><link rel="prefetch" href="/docs/assets/js/46.aafdef08.js"><link rel="prefetch" href="/docs/assets/js/47.595fd768.js"><link rel="prefetch" href="/docs/assets/js/48.a6540ad3.js"><link rel="prefetch" href="/docs/assets/js/49.726d0669.js"><link rel="prefetch" href="/docs/assets/js/5.8739eddd.js"><link rel="prefetch" href="/docs/assets/js/50.304f5c8a.js"><link rel="prefetch" href="/docs/assets/js/51.a24e9848.js"><link rel="prefetch" href="/docs/assets/js/52.e2dd0be4.js"><link rel="prefetch" href="/docs/assets/js/53.4f656f8b.js"><link rel="prefetch" href="/docs/assets/js/54.773afa1e.js"><link rel="prefetch" href="/docs/assets/js/55.b4b04462.js"><link rel="prefetch" href="/docs/assets/js/56.36eec085.js"><link rel="prefetch" href="/docs/assets/js/57.157d15a4.js"><link rel="prefetch" href="/docs/assets/js/58.e0c6d305.js"><link rel="prefetch" href="/docs/assets/js/59.33bac785.js"><link rel="prefetch" href="/docs/assets/js/6.05d88696.js"><link rel="prefetch" href="/docs/assets/js/60.fbb2bc1c.js"><link rel="prefetch" href="/docs/assets/js/61.31e6b365.js"><link rel="prefetch" href="/docs/assets/js/62.b21dbcb9.js"><link rel="prefetch" href="/docs/assets/js/63.d300ff10.js"><link rel="prefetch" href="/docs/assets/js/64.69f65722.js"><link rel="prefetch" href="/docs/assets/js/65.8f8d018d.js"><link rel="prefetch" href="/docs/assets/js/66.f335df08.js"><link rel="prefetch" href="/docs/assets/js/67.df717949.js"><link rel="prefetch" href="/docs/assets/js/68.11cf70a1.js"><link rel="prefetch" href="/docs/assets/js/69.cdd6ce02.js"><link rel="prefetch" href="/docs/assets/js/7.97313c33.js"><link rel="prefetch" href="/docs/assets/js/70.166b14ea.js"><link rel="prefetch" href="/docs/assets/js/71.acb0758d.js"><link rel="prefetch" href="/docs/assets/js/72.82990d4e.js"><link rel="prefetch" href="/docs/assets/js/73.53ae9974.js"><link rel="prefetch" href="/docs/assets/js/74.81e7b0e1.js"><link rel="prefetch" href="/docs/assets/js/75.a7db37d2.js"><link rel="prefetch" href="/docs/assets/js/76.2734cbb8.js"><link rel="prefetch" href="/docs/assets/js/77.a64ef896.js"><link rel="prefetch" href="/docs/assets/js/78.4c503dcb.js"><link rel="prefetch" href="/docs/assets/js/79.b0b40de1.js"><link rel="prefetch" href="/docs/assets/js/80.608970d9.js"><link rel="prefetch" href="/docs/assets/js/81.537f238c.js"><link rel="prefetch" href="/docs/assets/js/82.9e80b244.js"><link rel="prefetch" href="/docs/assets/js/83.21f21168.js"><link rel="prefetch" href="/docs/assets/js/84.8b2f4ce4.js"><link rel="prefetch" href="/docs/assets/js/86.625023d9.js"><link rel="prefetch" href="/docs/assets/js/87.96c0892d.js"><link rel="prefetch" href="/docs/assets/js/88.31271f14.js"><link rel="prefetch" href="/docs/assets/js/89.18d6c9a7.js"><link rel="prefetch" href="/docs/assets/js/90.e8c786af.js"><link rel="prefetch" href="/docs/assets/js/91.9d4e8723.js"><link rel="prefetch" href="/docs/assets/js/92.ae174bc0.js"><link rel="prefetch" href="/docs/assets/js/93.baaf9bc5.js"><link rel="prefetch" href="/docs/assets/js/94.0d885c47.js"><link rel="prefetch" href="/docs/assets/js/95.0d0b9732.js"><link rel="prefetch" href="/docs/assets/js/96.48dfb6f2.js"><link rel="prefetch" href="/docs/assets/js/97.1541b4e2.js"><link rel="prefetch" href="/docs/assets/js/98.728cf299.js"><link rel="prefetch" href="/docs/assets/js/99.791c7aa4.js"><link rel="prefetch" href="/docs/assets/js/vendors~docsearch.5a4296f1.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.5d5ec1c5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/docs/" class="home-link router-link-active"><img src="/docs/imgs/head.jpg" alt="月窗散记" class="logo"> <span class="site-name can-hide">月窗散记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/" class="nav-link">
  Home
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/" class="nav-link">
  Home
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/docs/wujie.html" class="sidebar-link">wujie</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/wujie.html#初始化" class="sidebar-link">初始化</a></li><li class="sidebar-sub-header"><a href="/docs/wujie.html#安装依赖" class="sidebar-link">安装依赖</a></li><li class="sidebar-sub-header"><a href="/docs/wujie.html#子模块a" class="sidebar-link">子模块A</a></li><li class="sidebar-sub-header"><a href="/docs/wujie.html#子模块b" class="sidebar-link">子模块B</a></li><li class="sidebar-sub-header"><a href="/docs/wujie.html#基座" class="sidebar-link">基座</a></li><li class="sidebar-sub-header"><a href="/docs/wujie.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/docs/实现Promise.html" class="sidebar-link">实现Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/实现Promise.html#分析" class="sidebar-link">分析</a></li><li class="sidebar-sub-header"><a href="/docs/实现Promise.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/坐标拾取组件封装.html" class="sidebar-link">坐标拾取组件封装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/坐标拾取组件封装.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/高德地图轨迹回放与滑块控制.html" class="sidebar-link">高德地图轨迹回放与滑块控制</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/高德地图轨迹回放与滑块控制.html#问题描述" class="sidebar-link">问题描述</a></li><li class="sidebar-sub-header"><a href="/docs/高德地图轨迹回放与滑块控制.html#实现代码" class="sidebar-link">实现代码</a></li></ul></li><li><a href="/docs/高德地图2.0点聚合bug及处理办法.html" class="sidebar-link">高德地图2.0点聚合bug及处理办法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/高德地图2.0点聚合bug及处理办法.html#问题描述" class="sidebar-link">问题描述</a></li><li class="sidebar-sub-header"><a href="/docs/高德地图2.0点聚合bug及处理办法.html#解决思路" class="sidebar-link">解决思路</a></li><li class="sidebar-sub-header"><a href="/docs/高德地图2.0点聚合bug及处理办法.html#代码实现" class="sidebar-link">代码实现</a></li></ul></li><li><a href="/docs/SharedWorker.html" class="sidebar-link">SharedWorker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/SharedWorker.html#初始化" class="sidebar-link">初始化</a></li><li class="sidebar-sub-header"><a href="/docs/SharedWorker.html#编写worker" class="sidebar-link">编写worker</a></li><li class="sidebar-sub-header"><a href="/docs/SharedWorker.html#使用" class="sidebar-link">使用</a></li><li class="sidebar-sub-header"><a href="/docs/SharedWorker.html#备注" class="sidebar-link">备注</a></li></ul></li><li><a href="/docs/分时函数.html" class="sidebar-link">分时函数</a></li><li><a href="/docs/大文件分片上传.html" class="sidebar-link">大文件分片上传</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/大文件分片上传.html#实现思路" class="sidebar-link">实现思路</a></li><li class="sidebar-sub-header"><a href="/docs/大文件分片上传.html#实现" class="sidebar-link">实现</a></li><li class="sidebar-sub-header"><a href="/docs/大文件分片上传.html#启动" class="sidebar-link">启动</a></li></ul></li><li><a href="/docs/sse.html" class="sidebar-link">SSE</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/sse.html#后台" class="sidebar-link">后台</a></li><li class="sidebar-sub-header"><a href="/docs/sse.html#前端" class="sidebar-link">前端</a></li><li class="sidebar-sub-header"><a href="/docs/sse.html#运行" class="sidebar-link">运行</a></li><li class="sidebar-sub-header"><a href="/docs/sse.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/docs/PWA.html" class="sidebar-link">PWA</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/PWA.html#配置-manifest-json" class="sidebar-link">配置 manifest.json</a></li><li class="sidebar-sub-header"><a href="/docs/PWA.html#编写worker" class="sidebar-link">编写worker</a></li><li class="sidebar-sub-header"><a href="/docs/PWA.html#初始化样式" class="sidebar-link">初始化样式</a></li><li class="sidebar-sub-header"><a href="/docs/PWA.html#初始化测试数据" class="sidebar-link">初始化测试数据</a></li><li class="sidebar-sub-header"><a href="/docs/PWA.html#配置-index-html" class="sidebar-link">配置 index.html</a></li></ul></li><li><a href="/docs/请求工具函数封装.html" class="sidebar-link">请求工具函数封装</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/请求工具函数封装.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/访问器处理双向影响数据.html" class="sidebar-link">访问器处理双向影响数据</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/访问器处理双向影响数据.html#代码" class="sidebar-link">代码</a></li></ul></li><li><a href="/docs/自定义日期组件.html" class="sidebar-link">自定义日期组件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/自定义日期组件.html#实现" class="sidebar-link">实现</a></li><li class="sidebar-sub-header"><a href="/docs/自定义日期组件.html#效果" class="sidebar-link">效果</a></li></ul></li><li><a href="/docs/http缓存.html" class="sidebar-link">http缓存</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/http缓存.html#强缓存" class="sidebar-link">强缓存</a></li><li class="sidebar-sub-header"><a href="/docs/http缓存.html#协商缓存" class="sidebar-link">协商缓存</a></li><li class="sidebar-sub-header"><a href="/docs/http缓存.html#代码" class="sidebar-link">代码</a></li></ul></li><li><a href="/docs/深拷贝、防抖和节流.html" class="sidebar-link">深拷贝、防抖和节流</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/深拷贝、防抖和节流.html#深拷贝" class="sidebar-link">深拷贝</a></li><li class="sidebar-sub-header"><a href="/docs/深拷贝、防抖和节流.html#防抖" class="sidebar-link">防抖</a></li><li class="sidebar-sub-header"><a href="/docs/深拷贝、防抖和节流.html#节流" class="sidebar-link">节流</a></li></ul></li><li><a href="/docs/pdf.js+带线条标注.html" class="sidebar-link">pdf.js+带线条标注</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/pdf.js+带线条标注.html#思路" class="sidebar-link">思路</a></li><li class="sidebar-sub-header"><a href="/docs/pdf.js+带线条标注.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/动态表单设计方案.html" class="sidebar-link">动态表单设计方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/动态表单设计方案.html#实现" class="sidebar-link">实现</a></li><li class="sidebar-sub-header"><a href="/docs/动态表单设计方案.html#效果" class="sidebar-link">效果</a></li></ul></li><li><a href="/docs/cadvisor+prometheus+grafana监控容器.html" class="sidebar-link">cadvisor+prometheus+grafana监控容器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/cadvisor+prometheus+grafana监控容器.html#部署" class="sidebar-link">部署</a></li><li class="sidebar-sub-header"><a href="/docs/cadvisor+prometheus+grafana监控容器.html#使用" class="sidebar-link">使用</a></li><li class="sidebar-sub-header"><a href="/docs/cadvisor+prometheus+grafana监控容器.html#效果" class="sidebar-link">效果</a></li></ul></li><li><a href="/docs/VScode实现远程免密登录.html" class="sidebar-link">VScode实现远程免密登录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/VScode实现远程免密登录.html#客户端生成公钥-若没有" class="sidebar-link">客户端生成公钥(若没有)</a></li><li class="sidebar-sub-header"><a href="/docs/VScode实现远程免密登录.html#将客户端的公钥放到服务器" class="sidebar-link">将客户端的公钥放到服务器</a></li><li class="sidebar-sub-header"><a href="/docs/VScode实现远程免密登录.html#配置权限" class="sidebar-link">配置权限</a></li><li class="sidebar-sub-header"><a href="/docs/VScode实现远程免密登录.html#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/docs/vue3单元测试.html" class="sidebar-link">vue3单元测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/vue3单元测试.html#初始化项目" class="sidebar-link">初始化项目</a></li><li class="sidebar-sub-header"><a href="/docs/vue3单元测试.html#测试函数" class="sidebar-link">测试函数</a></li><li class="sidebar-sub-header"><a href="/docs/vue3单元测试.html#测试vue组件" class="sidebar-link">测试vue组件</a></li><li class="sidebar-sub-header"><a href="/docs/vue3单元测试.html#交互测试-事件测试" class="sidebar-link">交互测试&amp;事件测试</a></li><li class="sidebar-sub-header"><a href="/docs/vue3单元测试.html#请求-注入" class="sidebar-link">请求&amp;注入</a></li><li class="sidebar-sub-header"><a href="/docs/vue3单元测试.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/docs/THREE.js渲染地图.html" class="sidebar-link">THREE.js渲染地图</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/THREE.js渲染地图.html#效果演示" class="sidebar-link">效果演示</a></li><li class="sidebar-sub-header"><a href="/docs/THREE.js渲染地图.html#前置说明" class="sidebar-link">前置说明</a></li><li class="sidebar-sub-header"><a href="/docs/THREE.js渲染地图.html#定义类型" class="sidebar-link">定义类型</a></li><li class="sidebar-sub-header"><a href="/docs/THREE.js渲染地图.html#实现思路" class="sidebar-link">实现思路</a></li><li class="sidebar-sub-header"><a href="/docs/THREE.js渲染地图.html#实现代码" class="sidebar-link">实现代码</a></li></ul></li><li><a href="/docs/使用视口尺寸和计算属性做响应式开发.html" class="sidebar-link">使用视口尺寸和计算属性做响应式开发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/使用视口尺寸和计算属性做响应式开发.html#定义等分大小" class="sidebar-link">定义等分大小</a></li></ul></li><li><a href="/docs/使用indexDB缓存THREE.js模型.html" class="sidebar-link">使用indexDB缓存THREE.js模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/使用indexDB缓存THREE.js模型.html#封装indexdb" class="sidebar-link">封装indexDB</a></li><li class="sidebar-sub-header"><a href="/docs/使用indexDB缓存THREE.js模型.html#调用" class="sidebar-link">调用</a></li></ul></li><li><a href="/docs/THREE笔记.html" class="sidebar-link">THREE笔记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#初始化" class="sidebar-link">初始化</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#纹理" class="sidebar-link">纹理</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#_3d字体" class="sidebar-link">3D字体</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#光源辅助" class="sidebar-link">光源辅助</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#阴影" class="sidebar-link">阴影</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#raycaster射线拾取" class="sidebar-link">Raycaster射线拾取</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#模型加载" class="sidebar-link">模型加载</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#blender" class="sidebar-link">blender</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#图像优化" class="sidebar-link">图像优化</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#顶点着色器" class="sidebar-link">顶点着色器</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#three钩子" class="sidebar-link">THREE钩子</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#后期处理" class="sidebar-link">后期处理</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#性能调优" class="sidebar-link">性能调优</a></li><li class="sidebar-sub-header"><a href="/docs/THREE笔记.html#向量" class="sidebar-link">向量</a></li></ul></li><li><a href="/docs/vue3响应式与组件渲染.html" class="active sidebar-link">vue3响应式与组件渲染</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/vue3响应式与组件渲染.html#初始化环境" class="sidebar-link">初始化环境</a></li><li class="sidebar-sub-header"><a href="/docs/vue3响应式与组件渲染.html#工具库函数编写" class="sidebar-link">工具库函数编写</a></li><li class="sidebar-sub-header"><a href="/docs/vue3响应式与组件渲染.html#依赖收集与触发" class="sidebar-link">依赖收集与触发</a></li><li class="sidebar-sub-header"><a href="/docs/vue3响应式与组件渲染.html#reactive和computed" class="sidebar-link">reactive和computed</a></li><li class="sidebar-sub-header"><a href="/docs/vue3响应式与组件渲染.html#组件渲染" class="sidebar-link">组件渲染</a></li></ul></li><li><a href="/docs/前端渲染大量数据方案.html" class="sidebar-link">前端渲染大量数据方案</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/前端渲染大量数据方案.html#实现" class="sidebar-link">实现</a></li><li class="sidebar-sub-header"><a href="/docs/前端渲染大量数据方案.html#效果演示" class="sidebar-link">效果演示</a></li></ul></li><li><a href="/docs/yapi.html" class="sidebar-link">yapi</a></li><li><a href="/docs/递归转while.html" class="sidebar-link">递归转while</a></li><li><a href="/docs/实现promise.all方法.html" class="sidebar-link">实现promise.all方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/实现promise.all方法.html#思路" class="sidebar-link">思路</a></li><li class="sidebar-sub-header"><a href="/docs/实现promise.all方法.html#代码实现" class="sidebar-link">代码实现</a></li><li class="sidebar-sub-header"><a href="/docs/实现promise.all方法.html#测试" class="sidebar-link">测试</a></li></ul></li><li><a href="/docs/vue3+tsx+keepAlive.html" class="sidebar-link">vue3+tsx+keepAlive</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/vue3+tsx+keepAlive.html#路由定义" class="sidebar-link">路由定义</a></li><li class="sidebar-sub-header"><a href="/docs/vue3+tsx+keepAlive.html#组件keep-alive" class="sidebar-link">组件keep-alive</a></li></ul></li><li><a href="/docs/Vue3+Electron.html" class="sidebar-link">Vue3+Electron</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/Vue3+Electron.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/docs/Vue3+Electron.html#运行" class="sidebar-link">运行</a></li><li class="sidebar-sub-header"><a href="/docs/Vue3+Electron.html#打包" class="sidebar-link">打包</a></li><li class="sidebar-sub-header"><a href="/docs/Vue3+Electron.html#报错" class="sidebar-link">报错</a></li><li class="sidebar-sub-header"><a href="/docs/Vue3+Electron.html#处理preload" class="sidebar-link">处理preload</a></li></ul></li><li><a href="/docs/ts重新设置类型.html" class="sidebar-link">ts重新设置类型</a></li><li><a href="/docs/ts指定key类型和其余任意key类型.html" class="sidebar-link">ts指定key类型和其余任意key类型</a></li><li><a href="/docs/ts将可选字段转化为必填字段.html" class="sidebar-link">ts将可选字段转化为必填字段</a></li><li><a href="/docs/ts定义必填属性，其余必须以指定开头为key.html" class="sidebar-link">ts定义必填属性，其余必须以指定开头为key</a></li><li><a href="/docs/skywalking.html" class="sidebar-link">skywalking</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/skywalking.html#创建挂载卷" class="sidebar-link">创建挂载卷</a></li><li class="sidebar-sub-header"><a href="/docs/skywalking.html#编写docker-compose-yml" class="sidebar-link">编写docker-compose.yml</a></li><li class="sidebar-sub-header"><a href="/docs/skywalking.html#nodejs使用" class="sidebar-link">nodejs使用</a></li></ul></li><li><a href="/docs/sass.html" class="sidebar-link">sass</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/sass.html#变量" class="sidebar-link">变量</a></li><li class="sidebar-sub-header"><a href="/docs/sass.html#嵌套" class="sidebar-link">嵌套</a></li><li class="sidebar-sub-header"><a href="/docs/sass.html#混入" class="sidebar-link">混入</a></li><li class="sidebar-sub-header"><a href="/docs/sass.html#继承" class="sidebar-link">继承</a></li><li class="sidebar-sub-header"><a href="/docs/sass.html#类型" class="sidebar-link">类型</a></li><li class="sidebar-sub-header"><a href="/docs/sass.html#interpolation" class="sidebar-link">Interpolation</a></li><li class="sidebar-sub-header"><a href="/docs/sass.html#if-else" class="sidebar-link">@if @else</a></li><li class="sidebar-sub-header"><a href="/docs/sass.html#for" class="sidebar-link">@for</a></li><li class="sidebar-sub-header"><a href="/docs/sass.html#each" class="sidebar-link">@each</a></li><li class="sidebar-sub-header"><a href="/docs/sass.html#while" class="sidebar-link">@while</a></li><li class="sidebar-sub-header"><a href="/docs/sass.html#function" class="sidebar-link">@function</a></li></ul></li><li><a href="/docs/rollup简要笔记.html" class="sidebar-link">rollup简要笔记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/rollup简要笔记.html#初始化" class="sidebar-link">初始化</a></li><li class="sidebar-sub-header"><a href="/docs/rollup简要笔记.html#修改tsconfig-json" class="sidebar-link">修改tsconfig.json</a></li><li class="sidebar-sub-header"><a href="/docs/rollup简要笔记.html#编写src-index-ts" class="sidebar-link">编写src/index.ts</a></li><li class="sidebar-sub-header"><a href="/docs/rollup简要笔记.html#编写rollup-config-js" class="sidebar-link">编写rollup.config.js</a></li><li class="sidebar-sub-header"><a href="/docs/rollup简要笔记.html#修改package-json" class="sidebar-link">修改package.json</a></li><li class="sidebar-sub-header"><a href="/docs/rollup简要笔记.html#打包" class="sidebar-link">打包</a></li></ul></li><li><a href="/docs/redis主从.html" class="sidebar-link">redis主从</a></li><li><a href="/docs/redis集群.html" class="sidebar-link">redis集群</a></li><li><a href="/docs/react+react-router-dom+redux.html" class="sidebar-link">react+react-router-dom+redux</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/react+react-router-dom+redux.html#创建项目" class="sidebar-link">创建项目</a></li><li class="sidebar-sub-header"><a href="/docs/react+react-router-dom+redux.html#路由" class="sidebar-link">路由</a></li><li class="sidebar-sub-header"><a href="/docs/react+react-router-dom+redux.html#导出具有ref的组件" class="sidebar-link">导出具有ref的组件</a></li><li class="sidebar-sub-header"><a href="/docs/react+react-router-dom+redux.html#redux" class="sidebar-link">redux</a></li><li class="sidebar-sub-header"><a href="/docs/react+react-router-dom+redux.html#antd" class="sidebar-link">antd</a></li></ul></li><li><a href="/docs/react-navtive.html" class="sidebar-link">react-navtive</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/react-navtive.html#版本信息" class="sidebar-link">版本信息</a></li><li class="sidebar-sub-header"><a href="/docs/react-navtive.html#环境安装参考" class="sidebar-link">环境安装参考</a></li><li class="sidebar-sub-header"><a href="/docs/react-navtive.html#安装jdk" class="sidebar-link">安装jdk</a></li><li class="sidebar-sub-header"><a href="/docs/react-navtive.html#配置环境变量" class="sidebar-link">配置环境变量</a></li><li class="sidebar-sub-header"><a href="/docs/react-navtive.html#安装-android-studio" class="sidebar-link">安装 Android Studio</a></li><li class="sidebar-sub-header"><a href="/docs/react-navtive.html#创建项目" class="sidebar-link">创建项目</a></li><li class="sidebar-sub-header"><a href="/docs/react-navtive.html#运行" class="sidebar-link">运行</a></li><li class="sidebar-sub-header"><a href="/docs/react-navtive.html#调试" class="sidebar-link">调试</a></li><li class="sidebar-sub-header"><a href="/docs/react-navtive.html#路由" class="sidebar-link">路由</a></li><li class="sidebar-sub-header"><a href="/docs/react-navtive.html#小技巧" class="sidebar-link">小技巧</a></li><li class="sidebar-sub-header"><a href="/docs/react-navtive.html#真机调试" class="sidebar-link">真机调试</a></li><li class="sidebar-sub-header"><a href="/docs/react-navtive.html#错误处理" class="sidebar-link">错误处理</a></li></ul></li><li><a href="/docs/prometheus-docker.html" class="sidebar-link">prometheus-docker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/prometheus-docker.html#prometheus主机-192-168-2-200" class="sidebar-link">prometheus主机（192.168.2.200）：</a></li><li class="sidebar-sub-header"><a href="/docs/prometheus-docker.html#被监控主机-192-168-2-201" class="sidebar-link">被监控主机（192.168.2.201）:</a></li><li class="sidebar-sub-header"><a href="/docs/prometheus-docker.html#使用" class="sidebar-link">使用</a></li></ul></li><li><a href="/docs/onlyoffice.html" class="sidebar-link">onlyoffice</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/onlyoffice.html#部署-onlyoffice" class="sidebar-link">部署 onlyoffice</a></li><li class="sidebar-sub-header"><a href="/docs/onlyoffice.html#后台" class="sidebar-link">后台</a></li><li class="sidebar-sub-header"><a href="/docs/onlyoffice.html#前端" class="sidebar-link">前端</a></li><li class="sidebar-sub-header"><a href="/docs/onlyoffice.html#效果" class="sidebar-link">效果</a></li></ul></li><li><a href="/docs/nuxt3笔记.html" class="sidebar-link">nuxt3笔记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#初始化" class="sidebar-link">初始化</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#路由" class="sidebar-link">路由</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#布局系统" class="sidebar-link">布局系统</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#组件" class="sidebar-link">组件</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#请求" class="sidebar-link">请求</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#动态请求" class="sidebar-link">动态请求</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#请求代理" class="sidebar-link">请求代理</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#中间件" class="sidebar-link">中间件</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#服务端中间件" class="sidebar-link">服务端中间件</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#状态管理-组合逻辑" class="sidebar-link">状态管理(组合逻辑)</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#utils" class="sidebar-link">utils</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#插件" class="sidebar-link">插件</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#sass" class="sidebar-link">sass</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#环境判断" class="sidebar-link">环境判断</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#运行时配置" class="sidebar-link">运行时配置</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#全局css注入" class="sidebar-link">全局css注入</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#使用阿里图标库" class="sidebar-link">使用阿里图标库</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#配置路径别名" class="sidebar-link">配置路径别名</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#pinia使用" class="sidebar-link">pinia使用</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#自定义指令" class="sidebar-link">自定义指令</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#装饰器的使用" class="sidebar-link">装饰器的使用</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#seo" class="sidebar-link">seo</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#客户端特定渲染" class="sidebar-link">客户端特定渲染</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#打包部署" class="sidebar-link">打包部署</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#其他问题" class="sidebar-link">其他问题</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3笔记.html#追加" class="sidebar-link">追加</a></li></ul></li><li><a href="/docs/nuxt3.html" class="sidebar-link">nuxt3</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#初始化" class="sidebar-link">初始化</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#路由" class="sidebar-link">路由</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#嵌套路由" class="sidebar-link">嵌套路由</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#动态路由" class="sidebar-link">动态路由</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#_404页面" class="sidebar-link">404页面</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#组件" class="sidebar-link">组件</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#layout" class="sidebar-link">layout</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#server" class="sidebar-link">server</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#组合逻辑" class="sidebar-link">组合逻辑</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#运行时配置" class="sidebar-link">运行时配置</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#三方插件pinia代替组合逻辑" class="sidebar-link">三方插件pinia代替组合逻辑</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#全局样式" class="sidebar-link">全局样式</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#其他" class="sidebar-link">其他</a></li><li class="sidebar-sub-header"><a href="/docs/nuxt3.html#未解决的问题" class="sidebar-link">未解决的问题</a></li></ul></li><li><a href="/docs/nginx简要笔记.html" class="sidebar-link">nginx简要笔记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/nginx简要笔记.html#root" class="sidebar-link">root</a></li><li class="sidebar-sub-header"><a href="/docs/nginx简要笔记.html#路径匹配" class="sidebar-link">路径匹配</a></li><li class="sidebar-sub-header"><a href="/docs/nginx简要笔记.html#proxy-pass" class="sidebar-link">proxy_pass</a></li><li class="sidebar-sub-header"><a href="/docs/nginx简要笔记.html#http升级https" class="sidebar-link">http升级https</a></li><li class="sidebar-sub-header"><a href="/docs/nginx简要笔记.html#跨域代理" class="sidebar-link">跨域代理</a></li><li class="sidebar-sub-header"><a href="/docs/nginx简要笔记.html#gzip压缩" class="sidebar-link">gzip压缩</a></li><li class="sidebar-sub-header"><a href="/docs/nginx简要笔记.html#完整示例" class="sidebar-link">完整示例</a></li></ul></li><li><a href="/docs/Nginx.html" class="sidebar-link">Nginx</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/Nginx.html#中间件架构" class="sidebar-link">中间件架构</a></li><li class="sidebar-sub-header"><a href="/docs/Nginx.html#代理服务器架构" class="sidebar-link">代理服务器架构</a></li><li class="sidebar-sub-header"><a href="/docs/Nginx.html#nginx的安装和使用" class="sidebar-link">Nginx的安装和使用</a></li><li class="sidebar-sub-header"><a href="/docs/Nginx.html#nginx的请求限制配置" class="sidebar-link">Nginx的请求限制配置</a></li><li class="sidebar-sub-header"><a href="/docs/Nginx.html#nginx的web静态资源服务" class="sidebar-link">Nginx的Web静态资源服务</a></li><li class="sidebar-sub-header"><a href="/docs/Nginx.html#代理服务器" class="sidebar-link">代理服务器</a></li><li class="sidebar-sub-header"><a href="/docs/Nginx.html#nginx代理服务" class="sidebar-link">Nginx代理服务</a></li><li class="sidebar-sub-header"><a href="/docs/Nginx.html#负载均衡调度slb" class="sidebar-link">负载均衡调度SLB</a></li><li class="sidebar-sub-header"><a href="/docs/Nginx.html#动态缓存" class="sidebar-link">动态缓存</a></li></ul></li><li><a href="/docs/nexus3.html" class="sidebar-link">nexus3</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/nexus3.html#安装" class="sidebar-link">安装</a></li><li class="sidebar-sub-header"><a href="/docs/nexus3.html#npm" class="sidebar-link">npm</a></li><li class="sidebar-sub-header"><a href="/docs/nexus3.html#docker" class="sidebar-link">docker</a></li></ul></li><li><a href="/docs/nest-GRPC.html" class="sidebar-link">nest-GRPC</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/nest-GRPC.html#初始化" class="sidebar-link">初始化</a></li><li class="sidebar-sub-header"><a href="/docs/nest-GRPC.html#nest-a" class="sidebar-link">nest-a</a></li><li class="sidebar-sub-header"><a href="/docs/nest-GRPC.html#nest-b" class="sidebar-link">nest-b</a></li><li class="sidebar-sub-header"><a href="/docs/nest-GRPC.html#验收" class="sidebar-link">验收</a></li></ul></li><li><a href="/docs/mysql8&amp;json.html" class="sidebar-link">mysql8&amp;json</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/mysql8&amp;json.html#部署mysql8" class="sidebar-link">部署mysql8</a></li><li class="sidebar-sub-header"><a href="/docs/mysql8&amp;json.html#使用" class="sidebar-link">使用</a></li><li class="sidebar-sub-header"><a href="/docs/mysql8&amp;json.html#结合nestjs" class="sidebar-link">结合nestjs</a></li></ul></li><li><a href="/docs/nestjs单元测试.html" class="sidebar-link">nestjs单元测试</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/nestjs单元测试.html#前置代码" class="sidebar-link">前置代码</a></li><li class="sidebar-sub-header"><a href="/docs/nestjs单元测试.html#测试代码" class="sidebar-link">测试代码</a></li><li class="sidebar-sub-header"><a href="/docs/nestjs单元测试.html#修改package-json配置" class="sidebar-link">修改package.json配置</a></li></ul></li><li><a href="/docs/nestjs+typeorm定时建表，动态查询表.html" class="sidebar-link">nestjs+typeorm定时建表，动态查询表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/nestjs+typeorm定时建表，动态查询表.html#定义实体" class="sidebar-link">定义实体</a></li><li class="sidebar-sub-header"><a href="/docs/nestjs+typeorm定时建表，动态查询表.html#定时创建表" class="sidebar-link">定时创建表</a></li><li class="sidebar-sub-header"><a href="/docs/nestjs+typeorm定时建表，动态查询表.html#动态查询表" class="sidebar-link">动态查询表</a></li></ul></li><li><a href="/docs/nest.html" class="sidebar-link">nest</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/nest.html#项目生成" class="sidebar-link">项目生成</a></li><li class="sidebar-sub-header"><a href="/docs/nest.html#依赖安装" class="sidebar-link">依赖安装</a></li><li class="sidebar-sub-header"><a href="/docs/nest.html#过滤器" class="sidebar-link">过滤器</a></li><li class="sidebar-sub-header"><a href="/docs/nest.html#守卫-权限验证" class="sidebar-link">守卫（权限验证）</a></li><li class="sidebar-sub-header"><a href="/docs/nest.html#集成安装过滤器、守卫、api文档和安全设置" class="sidebar-link">集成安装过滤器、守卫、api文档和安全设置</a></li><li class="sidebar-sub-header"><a href="/docs/nest.html#数据库" class="sidebar-link">数据库</a></li><li class="sidebar-sub-header"><a href="/docs/nest.html#测试案例" class="sidebar-link">测试案例</a></li><li class="sidebar-sub-header"><a href="/docs/nest.html#中间件" class="sidebar-link">中间件</a></li><li class="sidebar-sub-header"><a href="/docs/nest.html#中间件和子模块加入" class="sidebar-link">中间件和子模块加入</a></li><li class="sidebar-sub-header"><a href="/docs/nest.html#文件操作" class="sidebar-link">文件操作</a></li><li class="sidebar-sub-header"><a href="/docs/nest.html#定时任务" class="sidebar-link">定时任务</a></li></ul></li><li><a href="/docs/mysql.html" class="sidebar-link">mysql</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/mysql.html#使用docker安装mysql" class="sidebar-link">使用docker安装mysql</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#创建测试数据库并生成测试数据" class="sidebar-link">创建测试数据库并生成测试数据</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#基础查询" class="sidebar-link">基础查询</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#条件查询" class="sidebar-link">条件查询</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#排序查询" class="sidebar-link">排序查询</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#常见内置函数" class="sidebar-link">常见内置函数</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#分组查询" class="sidebar-link">分组查询</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#连接查询-多表查询" class="sidebar-link">连接查询(多表查询)</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#子查询" class="sidebar-link">子查询</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#分页查询" class="sidebar-link">分页查询</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#联合查询" class="sidebar-link">联合查询</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#查询关键字执行顺序" class="sidebar-link">查询关键字执行顺序</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#插入" class="sidebar-link">插入</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#修改" class="sidebar-link">修改</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#删除" class="sidebar-link">删除</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#库的管理" class="sidebar-link">库的管理</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#表达管理" class="sidebar-link">表达管理</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#常见数据类型" class="sidebar-link">常见数据类型</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#常见约束" class="sidebar-link">常见约束</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#事务" class="sidebar-link">事务</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#视图-用的少" class="sidebar-link">视图(用的少)</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#锁" class="sidebar-link">锁</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#变量" class="sidebar-link">变量</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#存储过程和函数" class="sidebar-link">存储过程和函数</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#循环" class="sidebar-link">循环</a></li><li class="sidebar-sub-header"><a href="/docs/mysql.html#递归查询" class="sidebar-link">递归查询</a></li></ul></li><li><a href="/docs/MinIO.html" class="sidebar-link">MinIO</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/MinIO.html#部署" class="sidebar-link">部署</a></li><li class="sidebar-sub-header"><a href="/docs/MinIO.html#在nestjs中使用" class="sidebar-link">在nestjs中使用</a></li></ul></li><li><a href="/docs/mariadb主从.html" class="sidebar-link">mariadb主从</a></li><li><a href="/docs/lodash源码阅读-cloneDeep.html" class="sidebar-link">lodash源码阅读-cloneDeep</a></li><li><a href="/docs/kafka-nestjs.html" class="sidebar-link">kafka-nestjs</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/kafka-nestjs.html#kafka基础概念" class="sidebar-link">kafka基础概念</a></li><li class="sidebar-sub-header"><a href="/docs/kafka-nestjs.html#部署-3个节点" class="sidebar-link">部署(3个节点)</a></li><li class="sidebar-sub-header"><a href="/docs/kafka-nestjs.html#结合nestjs-使用kafkajs" class="sidebar-link">结合nestjs(使用kafkajs)</a></li><li class="sidebar-sub-header"><a href="/docs/kafka-nestjs.html#测试" class="sidebar-link">测试</a></li></ul></li><li><a href="/docs/js通过字符串拿到对象属性.html" class="sidebar-link">js通过字符串拿到对象属性</a></li><li><a href="/docs/js判断对象是否存在某个属性.html" class="sidebar-link">js判断对象是否存在某个属性</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/js判断对象是否存在某个属性.html#直接判断是否等于undefined" class="sidebar-link">直接判断是否等于undefined</a></li><li class="sidebar-sub-header"><a href="/docs/js判断对象是否存在某个属性.html#object-keys" class="sidebar-link">Object.keys</a></li><li class="sidebar-sub-header"><a href="/docs/js判断对象是否存在某个属性.html#hasownproperty" class="sidebar-link">hasOwnProperty</a></li><li class="sidebar-sub-header"><a href="/docs/js判断对象是否存在某个属性.html#in" class="sidebar-link">in</a></li></ul></li><li><a href="/docs/实现new.html" class="sidebar-link">实现new</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/实现new.html#new的过程发生了什么" class="sidebar-link">new的过程发生了什么</a></li><li class="sidebar-sub-header"><a href="/docs/实现new.html#代码实现" class="sidebar-link">代码实现</a></li></ul></li><li><a href="/docs/gsap.html" class="sidebar-link">gsap</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/gsap.html#to" class="sidebar-link">to</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#from" class="sidebar-link">from</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#set" class="sidebar-link">set</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#timeline" class="sidebar-link">timeline</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#ticker" class="sidebar-link">ticker</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#exportroot" class="sidebar-link">exportRoot</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#getproperty" class="sidebar-link">getProperty</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#gettweensof" class="sidebar-link">getTweensOf</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#istweening" class="sidebar-link">isTweening</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#killtweensof" class="sidebar-link">killTweensOf</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#matchmedia" class="sidebar-link">matchMedia</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#matchmediarefresh" class="sidebar-link">matchMediaRefresh</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#utils" class="sidebar-link">utils</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#random" class="sidebar-link">random</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#flip" class="sidebar-link">Flip</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#draggable" class="sidebar-link">Draggable</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#motionpathplugin" class="sidebar-link">MotionPathPlugin</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#observer" class="sidebar-link">Observer</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#scrolltoplugin" class="sidebar-link">ScrollToPlugin</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#textplugin" class="sidebar-link">TextPlugin</a></li><li class="sidebar-sub-header"><a href="/docs/gsap.html#scrolltrigger" class="sidebar-link">scrollTrigger</a></li></ul></li><li><a href="/docs/graphgl(nest).html" class="sidebar-link">graphgl(nest)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/graphgl(nest).html#nest项目生成-依赖安装" class="sidebar-link">nest项目生成&amp;&amp;依赖安装</a></li><li class="sidebar-sub-header"><a href="/docs/graphgl(nest).html#schema" class="sidebar-link">schema</a></li><li class="sidebar-sub-header"><a href="/docs/graphgl(nest).html#database" class="sidebar-link">database</a></li><li class="sidebar-sub-header"><a href="/docs/graphgl(nest).html#server" class="sidebar-link">server</a></li><li class="sidebar-sub-header"><a href="/docs/graphgl(nest).html#resolver" class="sidebar-link">resolver</a></li><li class="sidebar-sub-header"><a href="/docs/graphgl(nest).html#访问" class="sidebar-link">访问</a></li><li class="sidebar-sub-header"><a href="/docs/graphgl(nest).html#前端" class="sidebar-link">前端</a></li><li class="sidebar-sub-header"><a href="/docs/graphgl(nest).html#类型" class="sidebar-link">类型</a></li><li class="sidebar-sub-header"><a href="/docs/graphgl(nest).html#参数" class="sidebar-link">参数</a></li></ul></li><li><a href="/docs/gitlab(docker)+git免密+CICD.html" class="sidebar-link">gitlab(docker)+git免密+CICD</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/gitlab(docker)+git免密+CICD.html#安装gitlab" class="sidebar-link">安装gitlab</a></li><li class="sidebar-sub-header"><a href="/docs/gitlab(docker)+git免密+CICD.html#安装gitlab-runner-ci-cd" class="sidebar-link">安装gitlab-runner(CI/CD)</a></li></ul></li><li><a href="/docs/elasticsearch.html" class="sidebar-link">elasticsearch</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/elasticsearch.html#docker部署elasticsearch" class="sidebar-link">docker部署elasticsearch</a></li><li class="sidebar-sub-header"><a href="/docs/elasticsearch.html#ik分词器添加" class="sidebar-link">ik分词器添加</a></li></ul></li><li><a href="/docs/EFK.html" class="sidebar-link">EFK</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/EFK.html#拉取镜像" class="sidebar-link">拉取镜像</a></li><li class="sidebar-sub-header"><a href="/docs/EFK.html#elasticsearch" class="sidebar-link">ElasticSearch</a></li><li class="sidebar-sub-header"><a href="/docs/EFK.html#kibana" class="sidebar-link">Kibana</a></li><li class="sidebar-sub-header"><a href="/docs/EFK.html#filebeat" class="sidebar-link">FileBeat</a></li><li class="sidebar-sub-header"><a href="/docs/EFK.html#使用" class="sidebar-link">使用</a></li><li class="sidebar-sub-header"><a href="/docs/EFK.html#设置密码" class="sidebar-link">设置密码</a></li></ul></li><li><a href="/docs/docker安装zookeeper集群.html" class="sidebar-link">docker安装zookeeper集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/docker安装zookeeper集群.html#最新版本报错找不到端口-百度说最新的发行版有问题-回到3-4-13版本" class="sidebar-link">最新版本报错找不到端口，百度说最新的发行版有问题，回到3.4.13版本</a></li><li class="sidebar-sub-header"><a href="/docs/docker安装zookeeper集群.html#后台运行-compose-project-name-zk-test-docker-compose-up-d-zk-test自定义名称" class="sidebar-link">后台运行 COMPOSEPROJECTNAME=zktest docker-compose up -d （zktest自定义名称）</a></li></ul></li><li><a href="/docs/docker-compose部署redis.html" class="sidebar-link">docker-compose部署redis</a></li><li><a href="/docs/js this指向.html" class="sidebar-link">js this指向</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/js this指向.html#常规" class="sidebar-link">常规</a></li><li class="sidebar-sub-header"><a href="/docs/js this指向.html#call、apply和bind" class="sidebar-link">call、apply和bind</a></li><li class="sidebar-sub-header"><a href="/docs/js this指向.html#箭头函数" class="sidebar-link">箭头函数</a></li></ul></li><li><a href="/docs/css高度从0过渡到auto.html" class="sidebar-link">css高度从0过渡到auto</a></li><li><a href="/docs/console.html" class="sidebar-link">console</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/console.html#常用方法" class="sidebar-link">常用方法</a></li><li class="sidebar-sub-header"><a href="/docs/console.html#部分实例" class="sidebar-link">部分实例</a></li><li class="sidebar-sub-header"><a href="/docs/console.html#css" class="sidebar-link">css</a></li></ul></li><li><a href="/docs/class-validator自定义校验.html" class="sidebar-link">class-validator自定义校验</a></li><li><a href="/docs/class-validator 验证装饰器.html" class="sidebar-link">class-validator 验证装饰器</a></li><li><a href="/docs/Blob 下载文件时 type 类型 大全.html" class="sidebar-link">Blob 下载文件时 type 类型 大全</a></li><li><a href="/docs/自定义装饰器校验数据.html" class="sidebar-link">自定义装饰器校验数据</a></li><li><a href="/docs/网站换肤.html" class="sidebar-link">网站换肤</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/网站换肤.html#创建项目-安装依赖" class="sidebar-link">创建项目&amp;安装依赖</a></li><li class="sidebar-sub-header"><a href="/docs/网站换肤.html#编写sass文件" class="sidebar-link">编写sass文件</a></li><li class="sidebar-sub-header"><a href="/docs/网站换肤.html#编辑vite-config-ts" class="sidebar-link">编辑vite.config.ts</a></li><li class="sidebar-sub-header"><a href="/docs/网站换肤.html#使用" class="sidebar-link">使用</a></li><li class="sidebar-sub-header"><a href="/docs/网站换肤.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/docs/算法-KMP.html" class="sidebar-link">算法-KMP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/算法-KMP.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/docs/算法-KMP.html#个人理解" class="sidebar-link">个人理解</a></li><li class="sidebar-sub-header"><a href="/docs/算法-KMP.html#最长相等前后缀" class="sidebar-link">最长相等前后缀</a></li></ul></li><li><a href="/docs/算法-bf.html" class="sidebar-link">算法-bf</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/算法-bf.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/docs/算法-bf.html#举例" class="sidebar-link">举例</a></li><li class="sidebar-sub-header"><a href="/docs/算法-bf.html#代码实现" class="sidebar-link">代码实现</a></li></ul></li><li><a href="/docs/算法-希尔排序.html" class="sidebar-link">算法-希尔排序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/算法-希尔排序.html#思路" class="sidebar-link">思路</a></li><li class="sidebar-sub-header"><a href="/docs/算法-希尔排序.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/算法-直接插入排序.html" class="sidebar-link">算法-直接插入排序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/算法-直接插入排序.html#基本思想" class="sidebar-link">基本思想</a></li><li class="sidebar-sub-header"><a href="/docs/算法-直接插入排序.html#算法描述" class="sidebar-link">算法描述</a></li><li class="sidebar-sub-header"><a href="/docs/算法-直接插入排序.html#适用范围" class="sidebar-link">适用范围</a></li><li class="sidebar-sub-header"><a href="/docs/算法-直接插入排序.html#代码实现" class="sidebar-link">代码实现</a></li><li class="sidebar-sub-header"><a href="/docs/算法-直接插入排序.html#个人理解" class="sidebar-link">个人理解</a></li></ul></li><li><a href="/docs/算法-快速排序.html" class="sidebar-link">算法-快速排序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/算法-快速排序.html#思路" class="sidebar-link">思路</a></li><li class="sidebar-sub-header"><a href="/docs/算法-快速排序.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/算法-简单选择排序.html" class="sidebar-link">算法-简单选择排序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/算法-简单选择排序.html#思路" class="sidebar-link">思路</a></li><li class="sidebar-sub-header"><a href="/docs/算法-简单选择排序.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/算法-赫夫曼编码.html" class="sidebar-link">算法-赫夫曼编码</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/算法-赫夫曼编码.html#工作原理" class="sidebar-link">工作原理</a></li><li class="sidebar-sub-header"><a href="/docs/算法-赫夫曼编码.html#赫夫曼树" class="sidebar-link">赫夫曼树</a></li><li class="sidebar-sub-header"><a href="/docs/算法-赫夫曼编码.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/算法-回溯法与八皇后问题.html" class="sidebar-link">算法-回溯法与八皇后问题</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/算法-回溯法与八皇后问题.html#八皇后问题" class="sidebar-link">八皇后问题</a></li><li class="sidebar-sub-header"><a href="/docs/算法-回溯法与八皇后问题.html#回溯法" class="sidebar-link">回溯法</a></li><li class="sidebar-sub-header"><a href="/docs/算法-回溯法与八皇后问题.html#实现" class="sidebar-link">实现</a></li><li class="sidebar-sub-header"><a href="/docs/算法-回溯法与八皇后问题.html#测试" class="sidebar-link">测试</a></li></ul></li><li><a href="/docs/算法-汉诺塔.html" class="sidebar-link">算法-汉诺塔</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/算法-汉诺塔.html#玩法" class="sidebar-link">玩法</a></li><li class="sidebar-sub-header"><a href="/docs/算法-汉诺塔.html#思路" class="sidebar-link">思路</a></li><li class="sidebar-sub-header"><a href="/docs/算法-汉诺塔.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/算法-斐波那契数列.html" class="sidebar-link">算法-斐波那契数列</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/算法-斐波那契数列.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/docs/算法-斐波那契数列.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/算法-二分查找.html" class="sidebar-link">算法-二分查找</a></li><li><a href="/docs/算法-堆排序.html" class="sidebar-link">算法-堆排序</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/算法-堆排序.html#前置名词解释" class="sidebar-link">前置名词解释</a></li><li class="sidebar-sub-header"><a href="/docs/算法-堆排序.html#基本思想" class="sidebar-link">基本思想</a></li><li class="sidebar-sub-header"><a href="/docs/算法-堆排序.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/算法-度量方法.html" class="sidebar-link">算法-度量方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/算法-度量方法.html#时间复杂度" class="sidebar-link">时间复杂度</a></li><li class="sidebar-sub-header"><a href="/docs/算法-度量方法.html#大o计数法" class="sidebar-link">大O计数法</a></li><li class="sidebar-sub-header"><a href="/docs/算法-度量方法.html#常用时间复杂度排序" class="sidebar-link">常用时间复杂度排序</a></li></ul></li><li><a href="/docs/数据结构-图.html" class="sidebar-link">数据结构-图</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/数据结构-图.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-图.html#基本概念" class="sidebar-link">基本概念</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-图.html#图的存储" class="sidebar-link">图的存储</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-图.html#图的遍历" class="sidebar-link">图的遍历</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-图.html#最小生成树" class="sidebar-link">最小生成树</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-图.html#最短路径" class="sidebar-link">最短路径</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-图.html#aov网" class="sidebar-link">AOV网</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-图.html#aoe网" class="sidebar-link">AOE网</a></li></ul></li><li><a href="/docs/数据结构-散列表.html" class="sidebar-link">数据结构-散列表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/数据结构-散列表.html#基本思想" class="sidebar-link">基本思想</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-散列表.html#散列表" class="sidebar-link">散列表</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-散列表.html#散列函数" class="sidebar-link">散列函数</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-散列表.html#散列地址" class="sidebar-link">散列地址</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-散列表.html#散列冲突" class="sidebar-link">散列冲突</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-散列表.html#处理冲突的方法" class="sidebar-link">处理冲突的方法</a></li></ul></li><li><a href="/docs/数据结构-平衡二叉树.html" class="sidebar-link">数据结构-平衡二叉树</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/数据结构-平衡二叉树.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-平衡二叉树.html#思路" class="sidebar-link">思路</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-平衡二叉树.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/数据结构-二叉排序树.html" class="sidebar-link">数据结构-二叉排序树</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/数据结构-二叉排序树.html#性质" class="sidebar-link">性质</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-二叉排序树.html#实现" class="sidebar-link">实现</a></li></ul></li><li><a href="/docs/数据结构-二叉树.html" class="sidebar-link">数据结构-二叉树</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/数据结构-二叉树.html#定义" class="sidebar-link">定义</a></li></ul></li><li><a href="/docs/数据结构-栈&amp;队列.html" class="sidebar-link">数据结构-栈&amp;队列</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/数据结构-栈&amp;队列.html#栈" class="sidebar-link">栈</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-栈&amp;队列.html#队列" class="sidebar-link">队列</a></li></ul></li><li><a href="/docs/数据结构-链表.html" class="sidebar-link">数据结构-链表</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/数据结构-链表.html#定义" class="sidebar-link">定义</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-链表.html#单向链表" class="sidebar-link">单向链表</a></li><li class="sidebar-sub-header"><a href="/docs/数据结构-链表.html#双向链表" class="sidebar-link">双向链表</a></li></ul></li><li><a href="/docs/ca自签名+配置https.html" class="sidebar-link">ca自签名+配置https</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/ca自签名+配置https.html#生成私钥" class="sidebar-link">生成私钥</a></li><li class="sidebar-sub-header"><a href="/docs/ca自签名+配置https.html#生成csr-证书签名请求" class="sidebar-link">生成CSR（证书签名请求）</a></li><li class="sidebar-sub-header"><a href="/docs/ca自签名+配置https.html#删除私钥中的密码" class="sidebar-link">删除私钥中的密码</a></li><li class="sidebar-sub-header"><a href="/docs/ca自签名+配置https.html#生成自签名证书" class="sidebar-link">生成自签名证书</a></li><li class="sidebar-sub-header"><a href="/docs/ca自签名+配置https.html#express使用" class="sidebar-link">express使用</a></li></ul></li><li><a href="/docs/centos7安装docker.html" class="sidebar-link">centos7安装docker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/centos7安装docker.html#更新yum包-安装需要的软件包" class="sidebar-link">更新yum包&amp;安装需要的软件包</a></li><li class="sidebar-sub-header"><a href="/docs/centos7安装docker.html#设置yum源-选择其中一个-我选的阿里仓库" class="sidebar-link">设置yum源（选择其中一个,我选的阿里仓库）</a></li><li class="sidebar-sub-header"><a href="/docs/centos7安装docker.html#安装docker" class="sidebar-link">安装Docker</a></li><li class="sidebar-sub-header"><a href="/docs/centos7安装docker.html#启动docker-并加入开机启动" class="sidebar-link">启动Docker,并加入开机启动</a></li><li class="sidebar-sub-header"><a href="/docs/centos7安装docker.html#配置阿里云加速-否则不能下载镜像" class="sidebar-link">配置阿里云加速，否则不能下载镜像</a></li><li class="sidebar-sub-header"><a href="/docs/centos7安装docker.html#安装docker-compose" class="sidebar-link">安装docker-compose</a></li></ul></li><li><a href="/docs/centos7搭建vsftp.html" class="sidebar-link">centos7搭建vsftp</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/centos7搭建vsftp.html#安装应用" class="sidebar-link">安装应用</a></li><li class="sidebar-sub-header"><a href="/docs/centos7搭建vsftp.html#备份配置文件" class="sidebar-link">备份配置文件</a></li><li class="sidebar-sub-header"><a href="/docs/centos7搭建vsftp.html#创建载体用户" class="sidebar-link">创建载体用户</a></li><li class="sidebar-sub-header"><a href="/docs/centos7搭建vsftp.html#修改载体用户目录权限" class="sidebar-link">修改载体用户目录权限</a></li><li class="sidebar-sub-header"><a href="/docs/centos7搭建vsftp.html#创建虚拟用户表" class="sidebar-link">创建虚拟用户表</a></li><li class="sidebar-sub-header"><a href="/docs/centos7搭建vsftp.html#生成db文件" class="sidebar-link">生成db文件</a></li><li class="sidebar-sub-header"><a href="/docs/centos7搭建vsftp.html#设置认证文件pam" class="sidebar-link">设置认证文件PAM</a></li></ul></li><li><a href="/docs/linux安装mysql.html" class="sidebar-link">linux安装mysql</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/linux安装mysql.html#配置mysql-8-0安装源" class="sidebar-link">配置Mysql 8.0安装源</a></li><li class="sidebar-sub-header"><a href="/docs/linux安装mysql.html#安装mysql-8-0" class="sidebar-link">安装Mysql 8.0</a></li><li class="sidebar-sub-header"><a href="/docs/linux安装mysql.html#启动mysql服务" class="sidebar-link">启动mysql服务</a></li><li class="sidebar-sub-header"><a href="/docs/linux安装mysql.html#拿到临时密码" class="sidebar-link">拿到临时密码</a></li><li class="sidebar-sub-header"><a href="/docs/linux安装mysql.html#登录" class="sidebar-link">登录</a></li><li class="sidebar-sub-header"><a href="/docs/linux安装mysql.html#查看当前的密码验证策略" class="sidebar-link">查看当前的密码验证策略</a></li><li class="sidebar-sub-header"><a href="/docs/linux安装mysql.html#重设密码" class="sidebar-link">重设密码</a></li><li class="sidebar-sub-header"><a href="/docs/linux安装mysql.html#配置远程访问" class="sidebar-link">配置远程访问</a></li></ul></li><li><a href="/docs/安全连接远程linux.html" class="sidebar-link">安全连接远程linux</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue3响应式与组件渲染"><a href="#vue3响应式与组件渲染" class="header-anchor">#</a> <center>vue3响应式与组件渲染</center></h1> <p>源码复杂，为了帮助学习和理解主要逻辑，参考vue3，删除些不是很重要的逻辑，编写一个简易版本的响应式模块和渲染模块。</p> <p>由于vue3的组件渲染是响应式，所以组件渲染的逻辑是依赖于响应式模块，而响应式模块依赖于依赖收集和触发模块。</p> <div class="language-txt extra-class"><pre class="language-txt"><code>依赖收集和触发模块 -&gt; 响应式模块 -&gt; 组件渲染
</code></pre></div><h2 id="初始化环境"><a href="#初始化环境" class="header-anchor">#</a> 初始化环境</h2> <p>为学习方便使用<code>webpack</code>打包和开启一个本地热更新服务器</p> <h3 id="安装依赖"><a href="#安装依赖" class="header-anchor">#</a> 安装依赖</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">mkdir</span> study_vue3
<span class="token builtin class-name">cd</span> study_vue3
<span class="token function">yarn</span> init <span class="token parameter variable">-y</span>
tsc <span class="token parameter variable">--init</span>
<span class="token function">yarn</span> <span class="token function">add</span> html-webpack-plugin ts-loader typescript webpack webpack-cli webpack-dev-server <span class="token parameter variable">-D</span>
</code></pre></div><h3 id="ts配置"><a href="#ts配置" class="header-anchor">#</a> ts配置</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> tsconfig.json
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;compilerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;outDir&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist/&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sourceMap&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;noImplicitAny&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;module&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es6&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;target&quot;</span><span class="token operator">:</span> <span class="token string">&quot;es2015&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;jsx&quot;</span><span class="token operator">:</span> <span class="token string">&quot;react&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;allowJs&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token property">&quot;moduleResolution&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;downlevelIteration&quot;</span><span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="创建html模板"><a href="#创建html模板" class="header-anchor">#</a> 创建html模板</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> public/index.html
</code></pre></div><div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>模板<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="入口文件"><a href="#入口文件" class="header-anchor">#</a> 入口文件</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/index.ts
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">/// &lt;reference types=&quot;webpack/module&quot; /&gt;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> name <span class="token operator">=</span> <span class="token string">'demo'</span>
<span class="token keyword">const</span> p <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">)</span>
document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
p<span class="token punctuation">.</span>innerText <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">hello </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> !</span><span class="token template-punctuation string">`</span></span>
</code></pre></div><h3 id="webpack配置"><a href="#webpack配置" class="header-anchor">#</a> webpack配置</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> webpack.config.js
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token comment">//导入node中path模块</span>
<span class="token comment">//打包html资源的插件使用,将src的html文件进行打包,完成后在dist文件夹中生成HTML文件,并对其处理，自动把使用的文件引用进去</span>
<span class="token keyword">const</span> HtmlWeabpckPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;html-webpack-plugin&quot;</span><span class="token punctuation">)</span>
 
<span class="token comment">//导出配置</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">mode</span><span class="token operator">:</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">,</span><span class="token comment">//运行模式,使用开发者模式</span>
    <span class="token literal-property property">entry</span><span class="token operator">:</span> <span class="token string">&quot;./src/index.ts&quot;</span><span class="token punctuation">,</span><span class="token comment">//入口文件</span>
    <span class="token literal-property property">output</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token comment">//打包后的出口文件</span>
        <span class="token literal-property property">path</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./dist&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token comment">//输出的路径</span>
        <span class="token literal-property property">filename</span><span class="token operator">:</span> <span class="token string">&quot;bundle.js&quot;</span><span class="token comment">//输出的文件名</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">resolve</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token comment">//配置可省略的文件扩展名</span>
        <span class="token literal-property property">extensions</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;.ts&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.js&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.cjs&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;.json&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">devServer</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">open</span><span class="token operator">:</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token comment">//热更新，可详细配置</span>
    <span class="token literal-property property">module</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">rules</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token comment">//打包ts的配置</span>
            <span class="token punctuation">{</span>
                <span class="token literal-property property">test</span><span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.ts$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                <span class="token literal-property property">loader</span><span class="token operator">:</span> <span class="token string">&quot;ts-loader&quot;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token comment">//创建一个空的HTML文件,自动引入打包输出的所有资源(JS/CSS)</span>
        <span class="token keyword">new</span> <span class="token class-name">HtmlWeabpckPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token comment">//复制'./public/index.html'文件,并自动引入打包输出的所有资源(JS/CSS)</span>
            <span class="token literal-property property">template</span><span class="token operator">:</span> <span class="token string">&quot;./public/index.html&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="添加启动脚本"><a href="#添加启动脚本" class="header-anchor">#</a> 添加启动脚本</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> package.json
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code>...
<span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;serve&quot;</span><span class="token operator">:</span> <span class="token string">&quot;webpack serve&quot;</span>
<span class="token punctuation">}</span>
...
</code></pre></div><h3 id="启动测试"><a href="#启动测试" class="header-anchor">#</a> 启动测试</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">yarn</span> serve
</code></pre></div><h2 id="工具库函数编写"><a href="#工具库函数编写" class="header-anchor">#</a> 工具库函数编写</h2> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/shared/utils.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getType</span> <span class="token operator">=</span> <span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> str <span class="token operator">=</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> str<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> str<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> isObject <span class="token operator">=</span> <span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> obj <span class="token keyword">is</span> object <span class="token operator">=&gt;</span> <span class="token function">getType</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;Object&quot;</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 判断参数是否是泛对象(比如数组)
 * @param {unknown} obj
 * @returns boolean
 * @example isGenericObject([]) === true
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> isGenericObject <span class="token operator">=</span> <span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> obj <span class="token keyword">is</span> object <span class="token operator">=&gt;</span>
    <span class="token keyword">typeof</span> obj <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> obj <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> isArray <span class="token operator">=</span> <span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> obj <span class="token keyword">is</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span><span class="token builtin">unknown</span><span class="token operator">&gt;</span> <span class="token operator">=&gt;</span>
    <span class="token function">getType</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;Array&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> isFunction <span class="token operator">=</span> <span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> obj <span class="token keyword">is</span> <span class="token builtin">Function</span> <span class="token operator">=&gt;</span>
    <span class="token function">getType</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;Function&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> isNumber <span class="token operator">=</span> <span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> obj <span class="token keyword">is</span> <span class="token builtin">number</span> <span class="token operator">=&gt;</span> <span class="token function">getType</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;Number&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> isString <span class="token operator">=</span> <span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> obj <span class="token keyword">is</span> <span class="token builtin">string</span> <span class="token operator">=&gt;</span> <span class="token function">getType</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;String&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> isSymbol <span class="token operator">=</span> <span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> obj <span class="token keyword">is</span> Symbol <span class="token operator">=&gt;</span> <span class="token function">getType</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;Symbol&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> isBoolean <span class="token operator">=</span> <span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> obj <span class="token keyword">is</span> <span class="token builtin">boolean</span> <span class="token operator">=&gt;</span> <span class="token function">getType</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;Boolean&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> isText <span class="token operator">=</span> <span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> obj <span class="token keyword">is</span> Text <span class="token operator">=&gt;</span> <span class="token function">getType</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;Text&quot;</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 判断val是否有属性key
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> hasOwn <span class="token operator">=</span> <span class="token punctuation">(</span>val<span class="token operator">:</span> object<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">)</span><span class="token operator">:</span> key <span class="token keyword">is</span> <span class="token keyword">keyof</span> <span class="token keyword">typeof</span> val <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">/**
 * 判断key是否是uint字符串
 */</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">isIntegerKey</span> <span class="token operator">=</span> <span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>
        <span class="token function">isString</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        key <span class="token operator">!==</span> <span class="token string">&quot;NAN&quot;</span> <span class="token operator">&amp;&amp;</span>
        <span class="token punctuation">(</span>key <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token string">&quot;-&quot;</span> <span class="token operator">&amp;&amp;</span>
        <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>key <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">===</span> key
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> nilValues <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">freeze</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">isNil</span> <span class="token operator">=</span> <span class="token punctuation">(</span>val<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> nilValues<span class="token punctuation">.</span><span class="token function">some</span><span class="token punctuation">(</span>ele <span class="token operator">=&gt;</span> ele <span class="token operator">===</span> val<span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">isNumberStr</span> <span class="token operator">=</span> <span class="token punctuation">(</span>str<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">isNaN</span><span class="token punctuation">(</span><span class="token function">Number</span><span class="token punctuation">(</span>str<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 布尔值字符串转布尔
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> BooleanString2Boolean <span class="token operator">=</span> <span class="token punctuation">(</span>
    value<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">boolean</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token operator">|</span> Error <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isBoolean</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value
    <span class="token punctuation">}</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> val <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token boolean">true</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        <span class="token boolean">false</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">[</span>value<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isBoolean</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;value转换Boolean失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> val
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> error <span class="token keyword">as</span> Error<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="依赖收集与触发"><a href="#依赖收集与触发" class="header-anchor">#</a> 依赖收集与触发</h2> <h3 id="特征"><a href="#特征" class="header-anchor">#</a> 特征</h3> <ul><li><code>effect</code>是一个函数</li> <li><code>effect</code>接收一个函数作为参数，还有一个配置项参数，是可选的</li> <li><code>track</code>是一个函数，作用是收集依赖</li> <li><code>trigger</code>是一个函数，作用是触发依赖更新</li></ul> <h3 id="思路"><a href="#思路" class="header-anchor">#</a> 思路</h3> <p><code>track</code>函数执行时，将参数和当前正在执行<code>effect</code>函数关联起来并保存起来，<code>trigger</code>函数执行时将参数关联的函数都执行一次。</p> <p><code>effect</code>、<code>track</code>和<code>trigger</code>相互独立又相互关联，若想<code>track</code>和<code>trigger</code>能获取到<code>effect</code>正在执行函数，则需要一个全局变量将之保存起来。</p> <p><code>effect</code>是个函数，可能存在嵌套情况，为了区分各个函数，需要一个栈来保存其顺序，进入外层函数时将外层函数推入栈中，进入内层函数时将内层函数推入栈中，内层函数执行完后将函数出栈，外层函数执行完后外层函数出栈。</p> <h3 id="实现"><a href="#实现" class="header-anchor">#</a> 实现</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/reactivity/constants.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// 常量</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token keyword">enum</span> ReactiveFlags <span class="token punctuation">{</span>
    <span class="token constant">IS_REACTIVE</span> <span class="token operator">=</span> <span class="token string">'__v_isReactive'</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/reactivity/effect.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> isArray <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../shared/utils&quot;</span>

<span class="token comment">/**
 * 保存effect执行关系
 * @example effect(() =&gt; effect(() =&gt; {}))
 * */</span> 
<span class="token keyword">const</span> effectStack<span class="token operator">:</span> ReactiveEffect<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token comment">/**
 * 当前正在执行effect
*/</span>
<span class="token keyword">let</span> activeEffect<span class="token operator">:</span> ReactiveEffect

<span class="token comment">/**
 * 包装effect函数
*/</span>
<span class="token keyword">class</span> <span class="token class-name">ReactiveEffect</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> active <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 是否响应式</span>
    <span class="token keyword">public</span> deps<span class="token operator">:</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> fn<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> <span class="token keyword">public</span> options<span class="token operator">:</span> EffectOptions<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 若不是响应式只需执行传入函数即可</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 防止死循环</span>
        <span class="token comment">// 具体来说防止在effect中有赋值操作</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>effectStack<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 使用数组来保存是为了防止effect嵌套effect的情况</span>
        effectStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
        <span class="token comment">// 实现收集依赖和触发依赖的关键就是这个activeEffect</span>
        <span class="token comment">// activeEffect包含了当前所需要执行effect函数</span>
        <span class="token comment">// 这个函数有获取响应式数据时，只需把这个函数保存起来就完成了依赖收集</span>
        <span class="token comment">// 所获取的数据发生改变时再执行这个函数也就是所谓的触发依赖</span>
        activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            effectStack<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            activeEffect <span class="token operator">=</span> effectStack<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 停止响应式</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>active<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/**
 * 存放所搜集的依赖
*/</span>
<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap<span class="token operator">&lt;</span>Object<span class="token punctuation">,</span> Map<span class="token operator">&lt;</span><span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;&gt;&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token comment">/**
 * 收集依赖
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> track <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 不在effect函数中的取值操作，不需要收集</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        depsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        targetMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> depsMap<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> dep <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        depsMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> dep<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span>
        dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 触发依赖更新
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> trigger <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> value<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> effects <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token comment">// // 对数组的length属性赋值需做特殊处理</span>
    <span class="token comment">// // 数组的length属性改变不仅需要更新length属性的依赖</span>
    <span class="token comment">// // 还需要更新超出新的值的依赖</span>
    <span class="token comment">// if(key === 'length' &amp;&amp; isArray(target) &amp;&amp; isNumber(value)) {</span>
    <span class="token comment">//     depsMap.forEach((deps, mykey) =&gt; {</span>
    <span class="token comment">//         if(</span>
    <span class="token comment">//             mykey === 'length' // 1.处理有依赖length的情况</span>
    <span class="token comment">//             || ( // 2.超出新设置的length的情况</span>
    <span class="token comment">//                 !isSymbol(mykey) </span>
    <span class="token comment">//                 &amp;&amp; (</span>
    <span class="token comment">//                     isNumber(mykey) </span>
    <span class="token comment">//                     || isNumberStr(mykey)</span>
    <span class="token comment">//                 ) </span>
    <span class="token comment">//                 &amp;&amp; Number(mykey) &gt;= value</span>
    <span class="token comment">//             )</span>
    <span class="token comment">//         ) {</span>
    <span class="token comment">//             deps.forEach(dep =&gt; effects.add(dep))</span>
    <span class="token comment">//         }</span>
    <span class="token comment">//     })</span>
    <span class="token comment">// }</span>

    <span class="token comment">// 对于数组应该有更细致打磨</span>
    <span class="token comment">// 比如对下标操作，可以精准更改</span>
    <span class="token comment">// 比如直接修改length或者调用push等方法，需要更新的依赖要好生斟酌</span>
    <span class="token comment">// 这里是简便处理，修改了length属性就把该对象的所有以来都执行了，有性能问题</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        depsMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>deps<span class="token punctuation">,</span> mykey<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            deps<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>dep <span class="token operator">=&gt;</span> effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    
    effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>effect <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 如果需要执行的effect和当前正在执行的effect时同一个，不要执行</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>effect <span class="token operator">!==</span> activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            effect<span class="token punctuation">.</span>options<span class="token punctuation">.</span>sch<span class="token operator">?.</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
<span class="token punctuation">}</span>

<span class="token comment">/**
 * effect options参数类型
*/</span>
<span class="token keyword">interface</span> <span class="token class-name">EffectOptions</span> <span class="token punctuation">{</span>
    lazy<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
    sch<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">Function</span></span><span class="token operator">&gt;</span><span class="token punctuation">(</span>fn<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">,</span> options<span class="token operator">:</span> EffectOptions <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> _effect <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">,</span> options<span class="token punctuation">)</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>options<span class="token punctuation">.</span>lazy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> runner<span class="token operator">:</span> <span class="token keyword">typeof</span> _effect<span class="token punctuation">.</span>run <span class="token operator">&amp;</span> <span class="token punctuation">{</span>effect<span class="token operator">:</span> ReactiveEffect<span class="token punctuation">}</span>  <span class="token operator">=</span> _effect<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>_effect<span class="token punctuation">)</span> <span class="token comment">// 注意this指向</span>
    runner<span class="token punctuation">.</span>effect <span class="token operator">=</span> _effect
    <span class="token keyword">return</span> runner
<span class="token punctuation">}</span>
</code></pre></div><h2 id="reactive和computed"><a href="#reactive和computed" class="header-anchor">#</a> reactive和computed</h2> <h3 id="思路-2"><a href="#思路-2" class="header-anchor">#</a> 思路</h3> <p>响应式的核心就是对象操作的拦截代理(具体来说是<code>get</code>和<code>set</code>)。在<code>get</code>对象的某个属性时，将<code>get</code>对象属性这个操作所在的函数和<code>对象及其属性</code>关联起来，再将之保存，这一步骤称之为收集依赖。在<code>set</code>对象的某个属性时，找到其关联的函数并执行，这一步骤称之为触发依赖更新。</p> <p>而实现代理的方法是<code>Proxy</code>，收集依赖和触发更新前边已经实现，可直接复用。</p> <h3 id="实现reactive"><a href="#实现reactive" class="header-anchor">#</a> 实现reactive</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/reactivity/reactive.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// 核心就是代理对象</span>
<span class="token comment">// 当用户获取或更改属性时可以做某些操作</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isGenericObject <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../shared/utils'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ReactiveFlags <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./constants'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> track<span class="token punctuation">,</span> trigger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./effect'</span>

<span class="token comment">/**
 * 缓存所有代理过的对象和其Proxy
*/</span>
<span class="token keyword">const</span> reactiveMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap<span class="token operator">&lt;</span>object<span class="token punctuation">,</span> object<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * 创建一个响应式对象。
 * 核心就是代理对象，在获取属性时收集依赖，而在设置属性时触发依赖。
 * 这里的依赖或许用函数来表示会便于理解
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> reactive <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> exist <span class="token operator">=</span> reactiveMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token constant">T</span> <span class="token operator">|</span> <span class="token keyword">undefined</span>
    <span class="token comment">// 如果有缓存Proxy，直接返回Proxy</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>exist<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> exist
    <span class="token punctuation">}</span>
    <span class="token comment">// 若传入的是一个Proxy对象，直接返回</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>target <span class="token keyword">as</span> <span class="token constant">T</span> <span class="token operator">&amp;</span> <span class="token punctuation">{</span><span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">[</span>ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> proxy <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> recevier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> ReactiveFlags<span class="token punctuation">.</span><span class="token constant">IS_REACTIVE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 用以判断是否是Proxy</span>
                <span class="token keyword">return</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 收集依赖</span>
            <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> recevier<span class="token punctuation">)</span>
            <span class="token comment">// Proxy只代理一层</span>
            <span class="token comment">// 读取时再懒代理下一层</span>
            <span class="token comment">// 作用一是生成代理对象</span>
            <span class="token comment">// 作用二是提高性能</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isGenericObject</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token function">reactive</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> recevier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> oldValue <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
            <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> recevier<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>oldValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 值发生变化了才需要触发更新</span>
                <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> res
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 将Proxy放入缓存</span>
    reactiveMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> proxy<span class="token punctuation">)</span>
    <span class="token keyword">return</span> proxy
<span class="token punctuation">}</span>
</code></pre></div><h3 id="测试reactive"><a href="#测试reactive" class="header-anchor">#</a> 测试reactive</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/index.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>effect<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./reactivity/effect'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>reactive<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./reactivity/reactive'</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">'app'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> runner <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    app<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> state<span class="token punctuation">.</span>count<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// runner.effect.stop()</span>
<span class="token keyword">const</span> timmer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>timmer<span class="token punctuation">)</span>
    state<span class="token punctuation">.</span>count<span class="token operator">++</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="实现computed"><a href="#实现computed" class="header-anchor">#</a> 实现computed</h3> <h3 id="特征-2"><a href="#特征-2" class="header-anchor">#</a> 特征</h3> <ul><li>计算属性是一个函数</li> <li>计算属性接受一个函数或者一个对象(需包含<code>set</code>和<code>get</code>属性)作为参数</li> <li>当入参为函数时，值是只读的</li> <li>计算属性需要通过<code>.value</code>取值</li> <li>计算属性依赖的值没有发生变化不会重新计算</li></ul> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/reactivity/computed.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> isFunction <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../shared/utils&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> effect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./effect&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ComputedGetter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">ComputedSetter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span>newValue<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">WritableComputedOptions<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    get<span class="token operator">:</span> ComputedGetter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
    set<span class="token operator">:</span> ComputedSetter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ComputedRefImpl<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> __v_isRef <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">private</span> _dirty <span class="token operator">=</span> <span class="token boolean">true</span> <span class="token comment">// 取值时是否需要更新</span>
    <span class="token keyword">private</span> _value<span class="token operator">:</span> <span class="token constant">T</span>
    <span class="token keyword">private</span> effect<span class="token operator">:</span> ReturnType<span class="token operator">&lt;</span><span class="token keyword">typeof</span> effect<span class="token operator">&gt;</span> 
    
    <span class="token function">constructor</span><span class="token punctuation">(</span>
        getter<span class="token operator">:</span> ComputedGetter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span> 
        <span class="token keyword">private</span> setter<span class="token operator">:</span> ComputedSetter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">,</span>
        <span class="token keyword">private</span> isReadonly<span class="token operator">:</span> <span class="token builtin">boolean</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>effect <span class="token operator">=</span> <span class="token function">effect</span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> <span class="token punctuation">{</span>
            lazy<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 默认不执行</span>
            <span class="token function-variable function">sch</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token comment">// 若依赖更新，将_dirty标记为true</span>
                <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dirty <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dirty <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>setter <span class="token operator">=</span> setter
    <span class="token punctuation">}</span>

    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_dirty<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_dirty <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value
    <span class="token punctuation">}</span>

    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span>val<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isReadonly<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setter</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">export</span> <span class="token keyword">const</span> computed <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>
    getterOrOptions<span class="token operator">:</span> ComputedGetter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> WritableComputedOptions<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">{</span>value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">}</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> getter<span class="token operator">:</span> ComputedGetter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
    <span class="token keyword">let</span> setter<span class="token operator">:</span> ComputedSetter<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
    <span class="token keyword">let</span> isReadonly<span class="token operator">:</span> <span class="token builtin">boolean</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>getterOrOptions<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        getter <span class="token operator">=</span> getterOrOptions
        <span class="token function-variable function">setter</span> <span class="token operator">=</span> <span class="token punctuation">(</span>val<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setter has been disabled'</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> val
        <span class="token punctuation">}</span>
        isReadonly <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        getter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">.</span>get
        setter <span class="token operator">=</span> getterOrOptions<span class="token punctuation">.</span>set
        isReadonly <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ComputedRefImpl<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span>getter<span class="token punctuation">,</span> setter<span class="token punctuation">,</span> isReadonly<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="组件渲染"><a href="#组件渲染" class="header-anchor">#</a> 组件渲染</h2> <p>组件渲染分为两层，一层做纯逻辑，将之放到<code>runtime-core</code>文件夹，一层操作dom,将之放到<code>runtime-dom</code>文件夹。</p> <p>依赖顺序</p> <div class="language-txt extra-class"><pre class="language-txt"><code>依赖收集和触发模块 -&gt; 响应式模块 -&gt; runtime-core -&gt; runtime-dom
</code></pre></div><p>初始化时调用<code>createApp</code>函数，该函数接收一个组件作为参数，一个可选参数props，返回一个App对象，App对象有一个<code>mount</code>方法挂载到容器中。</p> <p><code>mount</code>有dom操作，所以<code>createApp</code>是从<code>runtime-dom</code>导出。</p> <p>调用顺序:<code>runtime-dom</code>调用<code>runtime-core</code>时，将操作dom的api传递过去，<code>runtime-core</code>再返回虚拟节点及其操作api</p> <h3 id="runtime-dom之dom操作封装"><a href="#runtime-dom之dom操作封装" class="header-anchor">#</a> runtime-dom之dom操作封装</h3> <p>先将dom操作api封装下，<code>runtime-core</code>需要依赖</p> <h4 id="封装dom操作"><a href="#封装dom操作" class="header-anchor">#</a> 封装dom操作</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-dom/nodeOps.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">/**
 * 真实dom操作
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> nodeOps <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function-variable function">createElement</span><span class="token operator">:</span> <span class="token punctuation">(</span>tag<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">remove</span><span class="token operator">:</span> <span class="token punctuation">(</span>child<span class="token operator">:</span> Node<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        child<span class="token punctuation">.</span>parentNode<span class="token operator">?.</span><span class="token function">removeChild</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">insert</span><span class="token operator">:</span> <span class="token punctuation">(</span>child<span class="token operator">:</span> Node<span class="token punctuation">,</span> parent<span class="token operator">:</span> Node<span class="token punctuation">,</span> ancher<span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        parent<span class="token punctuation">.</span><span class="token function">insertBefore</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> ancher<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">querySelector</span><span class="token operator">:</span> <span class="token punctuation">(</span>selector<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>selector<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">setElementText</span><span class="token operator">:</span> <span class="token punctuation">(</span>el<span class="token operator">:</span> Node<span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span>textContent <span class="token operator">=</span> text<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">createText</span><span class="token operator">:</span> <span class="token punctuation">(</span>text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> document<span class="token punctuation">.</span><span class="token function">createTextNode</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function-variable function">setText</span><span class="token operator">:</span> <span class="token punctuation">(</span>node<span class="token operator">:</span> Node<span class="token punctuation">,</span> text<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        node<span class="token punctuation">.</span>nodeValue <span class="token operator">=</span> text<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token function-variable function">parentNode</span><span class="token operator">:</span> <span class="token punctuation">(</span>node<span class="token operator">:</span> Node<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> node<span class="token punctuation">.</span>parentNode <span class="token keyword">as</span> Element <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    <span class="token function-variable function">nextSibling</span><span class="token operator">:</span> <span class="token punctuation">(</span>node<span class="token operator">:</span> Node<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> node<span class="token punctuation">.</span>nextSibling<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="比对prop"><a href="#比对prop" class="header-anchor">#</a> 比对Prop</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-dom/patchProp.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> isString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../shared/utils&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> patchAttr <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./modules/attr&quot;</span> <span class="token comment">// 后续实现</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> patchClass <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./modules/class&quot;</span> <span class="token comment">// 后续实现</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> patchEvent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./modules/events&quot;</span> <span class="token comment">// 后续实现</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> patchStyle <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./modules/style&quot;</span> <span class="token comment">// 后续实现</span>

<span class="token comment">/**
 * 比对属性
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">patchProp</span> <span class="token operator">=</span> <span class="token punctuation">(</span>el<span class="token operator">:</span> Element<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> preValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> nextValue<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'class'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 类型</span>
        <span class="token function">isString</span><span class="token punctuation">(</span>nextValue<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">patchClass</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> nextValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key <span class="token operator">===</span> <span class="token string">'style'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 样式</span>
        <span class="token function">patchStyle</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> preValue<span class="token punctuation">,</span> nextValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^on[^a-z]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 事件:onXXX</span>
        <span class="token function">patchEvent</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> key<span class="token punctuation">,</span> nextValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 自定义属性</span>
        <span class="token function">patchAttr</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> key<span class="token punctuation">,</span> nextValue<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="比对class"><a href="#比对class" class="header-anchor">#</a> 比对class</h5> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-dom/modules/class.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> isNil <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../shared/utils&quot;</span>

<span class="token comment">/**
 * 比对class
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">patchClass</span> <span class="token operator">=</span> <span class="token punctuation">(</span>el<span class="token operator">:</span> Element<span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'class'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="比对样式"><a href="#比对样式" class="header-anchor">#</a> 比对样式</h5> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-dom/modules/style.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> isArray<span class="token punctuation">,</span> isNil<span class="token punctuation">,</span> isString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../shared/utils&quot;</span>

<span class="token keyword">type</span> <span class="token class-name">Style</span> <span class="token operator">=</span> <span class="token builtin">string</span> <span class="token operator">|</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token operator">|</span> <span class="token keyword">null</span>

<span class="token comment">/**
 * 设置css属性
*/</span>
<span class="token keyword">const</span> <span class="token function-variable function">setStyle</span> <span class="token operator">=</span> <span class="token punctuation">(</span>style<span class="token operator">:</span> CSSStyleDeclaration<span class="token punctuation">,</span> name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>val <span class="token operator">=&gt;</span> <span class="token function">setStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> name<span class="token punctuation">,</span> val<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        value <span class="token operator">=</span> <span class="token function">isNil</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token string">''</span> <span class="token operator">:</span> value
        <span class="token keyword">if</span> <span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'--'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            style<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            style<span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> 
        
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 比对样式
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">patchStyle</span> <span class="token operator">=</span> <span class="token punctuation">(</span>el<span class="token operator">:</span> Element<span class="token punctuation">,</span> prev<span class="token operator">:</span> Style<span class="token punctuation">,</span> next<span class="token operator">:</span> Style<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> _el <span class="token operator">=</span> el <span class="token keyword">as</span> HTMLElement
    <span class="token keyword">const</span> style <span class="token operator">=</span> _el<span class="token punctuation">.</span>style
    <span class="token keyword">const</span> preIsStr <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span>
    <span class="token keyword">const</span> nextIsStr <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span>

    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span>next<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span>prev<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>nextIsStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> next
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">setStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> key<span class="token punctuation">,</span> next<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>preIsStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>nextIsStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> next
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            _el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> <span class="token string">''</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 设置新的</span>
                <span class="token function">setStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> key<span class="token punctuation">,</span> next<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>nextIsStr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            _el<span class="token punctuation">.</span>style<span class="token punctuation">.</span>cssText <span class="token operator">=</span> next
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> prev<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 清除旧的</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span>next<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">setStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 设置新的</span>
                <span class="token function">setStyle</span><span class="token punctuation">(</span>style<span class="token punctuation">,</span> key<span class="token punctuation">,</span> next<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="比对事件"><a href="#比对事件" class="header-anchor">#</a> 比对事件</h5> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-dom/modules/events.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> isFunction<span class="token punctuation">,</span> isNil <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../shared/utils&quot;</span>

<span class="token keyword">interface</span> <span class="token class-name">Invoker</span> <span class="token keyword">extends</span> <span class="token class-name">EventListener</span> <span class="token punctuation">{</span>
    value<span class="token operator">:</span> EventValue
<span class="token punctuation">}</span>
<span class="token keyword">type</span> <span class="token class-name">EventValue</span> <span class="token operator">=</span> <span class="token builtin">Function</span> <span class="token operator">|</span> <span class="token builtin">Function</span><span class="token punctuation">[</span><span class="token punctuation">]</span>

<span class="token keyword">const</span> veiKey <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'_vei'</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> <span class="token function-variable function">createInvoker</span> <span class="token operator">=</span> <span class="token punctuation">(</span>nextValue<span class="token operator">:</span> EventValue<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> invoker<span class="token operator">:</span> <span class="token function-variable function">Invoker</span> <span class="token operator">=</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Event<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isFunction</span><span class="token punctuation">(</span>invoker<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            invoker<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        invoker<span class="token punctuation">.</span>value<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>fn <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    invoker<span class="token punctuation">.</span>value <span class="token operator">=</span> nextValue
    <span class="token keyword">return</span> invoker
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 比对事件。给元素新建一个属性Symbol('_vei')用以存放绑定的事件
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">patchEvent</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
    el<span class="token operator">:</span> Element <span class="token operator">&amp;</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>veiKey<span class="token punctuation">]</span><span class="token operator">?</span><span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Invoker <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> 
    key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> 
    nextValue<span class="token operator">:</span> EventValue <span class="token operator">|</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> invokers <span class="token operator">=</span> el<span class="token punctuation">[</span>veiKey<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">(</span>el<span class="token punctuation">[</span>veiKey<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> eventName <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// onXXX，从第二个开始截取事件名</span>
    <span class="token keyword">const</span> exists <span class="token operator">=</span> invokers<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>exists <span class="token operator">&amp;&amp;</span> nextValue<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 更新事件函数</span>
        exists<span class="token punctuation">.</span>value <span class="token operator">=</span> nextValue
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span> 

    <span class="token keyword">if</span><span class="token punctuation">(</span>nextValue<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 添加事件</span>
        invokers<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createInvoker</span><span class="token punctuation">(</span>nextValue<span class="token punctuation">)</span>
        el<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> invokers<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 删除事件</span>
        el<span class="token punctuation">.</span><span class="token function">removeEventListener</span><span class="token punctuation">(</span>eventName<span class="token punctuation">,</span> exists<span class="token punctuation">)</span>
        invokers<span class="token punctuation">[</span>eventName<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">void</span> <span class="token number">0</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h5 id="比对自定义属性"><a href="#比对自定义属性" class="header-anchor">#</a> 比对自定义属性</h5> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-dom/modules/attr.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> isNil <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../../shared/utils&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">patchAttr</span> <span class="token operator">=</span> <span class="token punctuation">(</span>el<span class="token operator">:</span> Element<span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span><span class="token function">removeAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        el<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="导出runtime-dom之dom操作"><a href="#导出runtime-dom之dom操作" class="header-anchor">#</a> 导出runtime-dom之dom操作</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-dom/index.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>nodeOps<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./nodeOps'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>patchProp<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./patchProp'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> renderOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>nodeOps<span class="token punctuation">,</span>
    patchProp
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">RenderOptions</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> renderOptions
</code></pre></div><h3 id="runtime-core"><a href="#runtime-core" class="header-anchor">#</a> runtime-core</h3> <h4 id="组件类型"><a href="#组件类型" class="header-anchor">#</a> 组件类型</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/shared/shapeFlags.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">enum</span> ShapeFlags <span class="token punctuation">{</span>
  <span class="token constant">ELEMENT</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// (html)元素</span>
  <span class="token constant">FUNCTIONAL_COMPONENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">// 函数式组件</span>
  <span class="token constant">STATEFUL_COMPONENT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token comment">// 普通组件</span>
  <span class="token constant">TEXT_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token comment">// 子节点时文本(明确不实现)</span>
  <span class="token constant">ARRAY_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token comment">// 子节点是数组</span>
  <span class="token constant">SLOTS_CHILDREN</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">// 组件时插槽</span>
  <span class="token constant">TELEPORT</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">,</span> <span class="token comment">// TELEPORT组件</span>
  <span class="token constant">SUSPENSE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">,</span> <span class="token comment">// SUSPENSE组件</span>
  <span class="token constant">COMPONENT_SHOULD_KEEP_ALIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">,</span>
  <span class="token constant">COMPONENT_KEPT_ALIVE</span> <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">,</span>
  <span class="token constant">COMPONENT</span> <span class="token operator">=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">STATEFUL_COMPONENT</span> <span class="token operator">|</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">FUNCTIONAL_COMPONENT</span><span class="token punctuation">,</span> <span class="token comment">// 组件</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/shared/index.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token operator">*</span> <span class="token keyword">as</span> utils <span class="token keyword">from</span> <span class="token string">'./utils'</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>ShapeFlags<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./shapeFlags'</span>
</code></pre></div><h4 id="组件和vnode"><a href="#组件和vnode" class="header-anchor">#</a> 组件和VNode</h4> <p>首先定义类型，方便后续代码编写</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-core/vnode.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ShapeFlags <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../shared&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> hasOwn<span class="token punctuation">,</span> isArray<span class="token punctuation">,</span> isNumber<span class="token punctuation">,</span> isObject<span class="token punctuation">,</span> isString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../shared/utils&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token keyword">type</span> <span class="token class-name">Instance</span><span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token class-name">Component</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./component&quot;</span><span class="token punctuation">;</span> <span class="token comment">// 后续编写</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">TEXT</span> <span class="token operator">=</span> <span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token string">'text'</span><span class="token punctuation">)</span>

<span class="token comment">/**
 * string说明是原生元素，比如div；对象说明是组件.TEXT表示时文本节点
*/</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">VNodeTypes</span> <span class="token operator">=</span> <span class="token builtin">string</span> <span class="token operator">|</span> Component <span class="token operator">|</span> <span class="token keyword">typeof</span> <span class="token constant">TEXT</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ExtraProps</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNodeProps</span> <span class="token punctuation">{</span>
    key<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">symbol</span>
<span class="token punctuation">}</span>
<span class="token comment">/**
 * 虚拟节点就是一个对象，用来描述dom的信息
*/</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">VNode</span> <span class="token punctuation">{</span>
    __v_isVNode<span class="token operator">:</span> <span class="token boolean">true</span>
    type<span class="token operator">:</span> VNodeTypes
    shapeFlag<span class="token operator">:</span> <span class="token builtin">number</span>
    props<span class="token operator">:</span> <span class="token punctuation">(</span>ExtraProps <span class="token operator">&amp;</span> VNodeProps<span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token keyword">null</span>
    children<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">string</span> <span class="token operator">|</span> VNode <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">string</span> <span class="token operator">|</span> VNode<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    component<span class="token operator">:</span> Instance <span class="token operator">|</span> <span class="token keyword">null</span>
    el<span class="token operator">:</span> Element <span class="token operator">|</span> Text <span class="token operator">|</span> <span class="token keyword">null</span>
    key<span class="token operator">?</span><span class="token operator">:</span> VNodeProps<span class="token punctuation">[</span><span class="token string">'key'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 创建vnode。children做限定只接受数组，不考虑其他兼容，方便代码实现
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> createVnode <span class="token operator">=</span> <span class="token punctuation">(</span>type<span class="token operator">:</span> VNodeTypes<span class="token punctuation">,</span> props<span class="token operator">:</span> ExtraProps <span class="token operator">&amp;</span> VNodeProps<span class="token punctuation">,</span> children<span class="token operator">?</span><span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'children'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> VNode <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> _type <span class="token operator">=</span> <span class="token function">isString</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> 
        <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span>
        <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token operator">?</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> vnode<span class="token operator">:</span> VNode <span class="token operator">=</span>  <span class="token punctuation">{</span>
        __v_isVNode<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        type<span class="token punctuation">,</span>
        shapeFlag<span class="token operator">:</span> _type<span class="token punctuation">,</span>
        props<span class="token punctuation">,</span>
        children<span class="token punctuation">,</span>
        component<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        el<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
        key<span class="token operator">:</span> props<span class="token punctuation">.</span>key<span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>shapeFlag <span class="token operator">|=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isNumber</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">.</span>shapeFlag <span class="token operator">|=</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> vnode
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> isVNode <span class="token operator">=</span> <span class="token punctuation">(</span>val<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> val <span class="token keyword">is</span> VNode <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">hasOwn</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> <span class="token string">'__v_isVNode'</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">(</span>val <span class="token keyword">as</span> VNode<span class="token punctuation">)</span><span class="token punctuation">.</span>__v_isVNode <span class="token operator">:</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">isSameVNodeType</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token operator">:</span> VNode<span class="token punctuation">,</span> n2<span class="token operator">:</span> VNode<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> n1<span class="token punctuation">.</span>type <span class="token operator">===</span> n2<span class="token punctuation">.</span>type <span class="token operator">&amp;&amp;</span> n1<span class="token punctuation">.</span>key <span class="token operator">===</span> n2<span class="token punctuation">.</span>key
<span class="token punctuation">}</span>
</code></pre></div><p>不再实现<code>h</code>函数，<code>h</code>函数本质就是调用<code>createVnode</code>函数</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-core/renderer.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">type</span> <span class="token class-name">VNode</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./vnode&quot;</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> VNode
</code></pre></div><div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-core/component.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../reactivity/reactive&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">type</span> <span class="token class-name">LifeCycles</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./apilifecycle&quot;</span> <span class="token comment">// 后续实现</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Render <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./renderer&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">type</span> <span class="token class-name">ExtraProps</span><span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token class-name">VNodeProps</span><span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token class-name">VNode</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./vnode&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>
    attrs<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span>
    emit<span class="token operator">:</span> <span class="token builtin">Function</span>
    expose<span class="token operator">:</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name">object</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>obj<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span>
    _<span class="token operator">:</span> Instance
<span class="token punctuation">}</span> 
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Component</span> <span class="token punctuation">{</span>
    props<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token function-variable function">setup</span><span class="token operator">:</span> <span class="token punctuation">(</span>props<span class="token operator">:</span> ExtraProps <span class="token operator">&amp;</span> VNodeProps<span class="token punctuation">,</span> ctx<span class="token operator">:</span> Context<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Render
<span class="token punctuation">}</span>


<span class="token keyword">type</span> <span class="token class-name">LifeCyclesFn</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>key <span class="token keyword">in</span> LifeCycles<span class="token punctuation">]</span><span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">Instance</span> <span class="token keyword">extends</span> <span class="token class-name">LifeCyclesFn</span>  <span class="token punctuation">{</span>
    vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> <span class="token comment">// 实例对应的虚拟节点</span>
    type<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token comment">// 组件对象</span>
    ctx<span class="token operator">:</span> Context <span class="token comment">// 组件上下文</span>
    propsOptions<span class="token operator">:</span> Component<span class="token punctuation">[</span><span class="token string">'props'</span><span class="token punctuation">]</span> <span class="token comment">// 接收的属性名</span>
    props<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'props'</span><span class="token punctuation">]</span> <span class="token comment">// 传入组件属性 用户传入+其他(比如minix)</span>
    attrs<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token comment">// 除了props的属性</span>
    emit<span class="token operator">:</span> Context<span class="token punctuation">[</span><span class="token string">'emit'</span><span class="token punctuation">]</span>
    exposed<span class="token operator">:</span> ReturnType<span class="token operator">&lt;</span>Context<span class="token punctuation">[</span><span class="token string">'expose'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
    render<span class="token operator">:</span> ReturnType<span class="token operator">&lt;</span>Component<span class="token punctuation">[</span><span class="token string">'setup'</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> <span class="token comment">// setup返回值,只实现setup返回render，外层render不再实现 </span>
    proxy<span class="token operator">:</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> <span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token comment">// 实例代理对象</span>
    isMounted<span class="token operator">:</span> <span class="token builtin">boolean</span> <span class="token comment">// 是否已挂载</span>
    subTree<span class="token operator">?</span><span class="token operator">:</span> VNode <span class="token comment">// 组件渲染内容</span>
<span class="token punctuation">}</span> 

<span class="token comment">/**
 * 生成组件实例.注意生成的组件实例大多都是空白，赋值再另一个函数：setupComponent
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> createComponentInstance <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNode<span class="token punctuation">)</span><span class="token operator">:</span> Instance <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>type<span class="token punctuation">}</span> <span class="token operator">=</span> vnode
    <span class="token keyword">const</span> instance<span class="token operator">:</span> Instance <span class="token operator">=</span> <span class="token punctuation">{</span>
        vnode<span class="token punctuation">,</span>
        type<span class="token punctuation">,</span>
        ctx<span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
        props<span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
        propsOptions<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token class-name"><span class="token keyword">as</span></span> Component<span class="token punctuation">)</span><span class="token punctuation">.</span>props <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        attrs<span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
        emit<span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
        exposed<span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
        render<span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
        proxy<span class="token operator">:</span> <span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">,</span>
        isMounted<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>ctx <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token keyword">as</span> Context<span class="token punctuation">)</span><span class="token punctuation">.</span>_ <span class="token operator">=</span> instance
    <span class="token keyword">return</span> instance
<span class="token punctuation">}</span>

<span class="token keyword">const</span> createSetupContext <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token operator">:</span> Instance<span class="token punctuation">)</span><span class="token operator">:</span> Context <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        attrs<span class="token operator">:</span> instance<span class="token punctuation">.</span>attrs<span class="token punctuation">,</span>
        emit<span class="token operator">:</span> instance<span class="token punctuation">.</span>emit<span class="token punctuation">,</span>
        <span class="token function-variable function">expose</span><span class="token operator">:</span> <span class="token punctuation">(</span>exposed<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            instance<span class="token punctuation">.</span>exposed <span class="token operator">=</span> exposed <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            <span class="token keyword">return</span> exposed
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        _<span class="token operator">:</span> instance
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 当前组件实例
*/</span>
<span class="token keyword">export</span> <span class="token keyword">let</span> currentInstance<span class="token operator">:</span> Instance <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">getCurrentInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> currentInstance
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">setCurrentInstance</span> <span class="token operator">=</span> <span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token keyword">typeof</span> currentInstance<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    currentInstance <span class="token operator">=</span> target
<span class="token punctuation">}</span>
<span class="token keyword">const</span> <span class="token function-variable function">setuoStateFulComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token operator">:</span> Instance<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>setup<span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token keyword">type</span> <span class="token class-name"><span class="token keyword">as</span></span> Component
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>setup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 在setup执行之前设置currentInstance</span>
    <span class="token comment">// 执行完之后置空</span>
    <span class="token comment">// 这样可以保证在setup函数之内拿到当前组件实例</span>
    <span class="token function">setCurrentInstance</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span>
    instance<span class="token punctuation">.</span>render <span class="token operator">=</span> <span class="token function">setup</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>props<span class="token punctuation">,</span> <span class="token function">createSetupContext</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token function">setCurrentInstance</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> initProps <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token operator">:</span> Instance<span class="token punctuation">,</span> rawProps<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'props'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> props<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'props'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">const</span> attrs<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'props'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>rawProps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> rawProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>propsOptions<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            props<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            attrs<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    instance<span class="token punctuation">.</span>props <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span>
    instance<span class="token punctuation">.</span>attrs <span class="token operator">=</span> attrs
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 给组件实例赋值
*/</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">setupComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token operator">:</span> Instance<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>props<span class="token punctuation">,</span> children<span class="token punctuation">}</span> <span class="token operator">=</span> instance<span class="token punctuation">.</span>vnode <span class="token comment">// TODO 插槽</span>
    <span class="token function">initProps</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> props<span class="token punctuation">)</span>
    <span class="token function">setuoStateFulComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="生命周期"><a href="#生命周期" class="header-anchor">#</a> 生命周期</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-core/apilifecycle.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> hasOwn<span class="token punctuation">,</span> isNil <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../shared/utils&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>currentInstance<span class="token punctuation">,</span> setCurrentInstance<span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token class-name">Instance</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./component&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">enum</span> LifeCycles   <span class="token punctuation">{</span>
    <span class="token constant">BEFORE_MOUNT</span> <span class="token operator">=</span> <span class="token string">'bm'</span><span class="token punctuation">,</span>
    <span class="token constant">MOUNTED</span> <span class="token operator">=</span> <span class="token string">'m'</span><span class="token punctuation">,</span>
    <span class="token constant">BEFORE_UPDATE</span> <span class="token operator">=</span> <span class="token string">'bu'</span><span class="token punctuation">,</span>
    <span class="token constant">UPDATED</span> <span class="token operator">=</span> <span class="token string">'u'</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">injectHook</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lifeCycle<span class="token operator">:</span> LifeCycles<span class="token punctuation">,</span> hook<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> target<span class="token operator">?</span><span class="token operator">:</span> Instance<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> lifeCycle<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        target<span class="token punctuation">[</span>lifeCycle<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> hooks <span class="token operator">=</span> target<span class="token punctuation">[</span>lifeCycle<span class="token punctuation">]</span>
    <span class="token keyword">const</span> <span class="token function-variable function">rap</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setCurrentInstance</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span>
        <span class="token function">hook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">setCurrentInstance</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    hooks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>rap<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token function-variable function">createHook</span> <span class="token operator">=</span> <span class="token punctuation">(</span>lifecycle<span class="token operator">:</span> LifeCycles<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>hook<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> target <span class="token operator">=</span> currentInstance<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">injectHook</span><span class="token punctuation">(</span>lifecycle<span class="token punctuation">,</span> hook<span class="token punctuation">,</span> target<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> onBeforeMount <span class="token operator">=</span> <span class="token function">createHook</span><span class="token punctuation">(</span>LifeCycles<span class="token punctuation">.</span><span class="token constant">BEFORE_MOUNT</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> onMounted <span class="token operator">=</span> <span class="token function">createHook</span><span class="token punctuation">(</span>LifeCycles<span class="token punctuation">.</span><span class="token constant">MOUNTED</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> onBeforeUpdate <span class="token operator">=</span> <span class="token function">createHook</span><span class="token punctuation">(</span>LifeCycles<span class="token punctuation">.</span><span class="token constant">BEFORE_UPDATE</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> onUpdated <span class="token operator">=</span> <span class="token function">createHook</span><span class="token punctuation">(</span>LifeCycles<span class="token punctuation">.</span><span class="token constant">UPDATED</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="生成app"><a href="#生成app" class="header-anchor">#</a> 生成APP</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-core/apiCreateApp.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> RenderOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../runtime-dom&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../shared/utils&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">type</span> <span class="token class-name">Component</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./component&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createVnode<span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token class-name">ExtraProps</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./vnode&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createAppAPI</span> <span class="token operator">=</span> <span class="token punctuation">(</span>render<span class="token operator">:</span> <span class="token builtin">Function</span><span class="token punctuation">,</span> renderOptions<span class="token operator">:</span> RenderOptions<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>component<span class="token operator">:</span> Component<span class="token punctuation">,</span> rootProps<span class="token operator">:</span> ExtraProps<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> isMounted <span class="token operator">=</span> <span class="token boolean">false</span>
        <span class="token keyword">const</span> app <span class="token operator">=</span>  <span class="token punctuation">{</span>
            <span class="token function">mount</span><span class="token punctuation">(</span>container<span class="token operator">:</span> Element <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    container <span class="token operator">=</span> renderOptions<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">const</span> vnode <span class="token operator">=</span> <span class="token function">createVnode</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> rootProps<span class="token punctuation">)</span>
                <span class="token function">render</span><span class="token punctuation">(</span>vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
                
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    isMounted <span class="token operator">=</span> <span class="token boolean">true</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> app
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="渲染逻辑和更新逻辑"><a href="#渲染逻辑和更新逻辑" class="header-anchor">#</a> 渲染逻辑和更新逻辑</h4> <p>简单来说就是新旧节点进行比对，如果有变化就将节点进行更新；然后对其子节点递归比对。</p> <p>在比对的时候根据节点的类型不同(文本、元素和组件)，走不同的比对逻辑(也就是diff)。</p> <p>diff元素较为容易，较为困难的是diff子节点，特别是前后子节点都是数组时。</p> <p>对于前后子节点都是数组时，首先从头比对，直到遇到不同的节点或超出任意前后节点数时停下。</p> <p>然后从尾开始比对，也是直到遇到不同的节点或超出任意前后节点数时停下。</p> <p>此时前后节点都是相同的，中间节点是有差异的部分。将有差异的旧节点元素删除并换上新节点的元素即可。</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-core/renderer.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> effect <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../reactivity/effect&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> RenderOptions <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../runtime-dom&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ShapeFlags <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../shared&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> hasOwn<span class="token punctuation">,</span> isArray<span class="token punctuation">,</span> isNil<span class="token punctuation">,</span> isNumber<span class="token punctuation">,</span> isString<span class="token punctuation">,</span> isText <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../shared/utils&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> createAppAPI <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./apiCreateApp&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Instance<span class="token punctuation">,</span> createComponentInstance<span class="token punctuation">,</span> setupComponent <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./component&quot;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token constant">TEXT</span><span class="token punctuation">,</span> VNode<span class="token punctuation">,</span> createVnode<span class="token punctuation">,</span> isSameVNodeType<span class="token punctuation">,</span> isVNode <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;./vnode&quot;</span>

<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">Render</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> VNode

<span class="token comment">/**
 * 二分查找
*/</span>
<span class="token keyword">const</span> <span class="token function-variable function">half</span> <span class="token operator">=</span> <span class="token punctuation">(</span>values<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> indexs<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span> val<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> start <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">let</span> end <span class="token operator">=</span> indexs<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token keyword">let</span> mid <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> start
    <span class="token keyword">while</span><span class="token punctuation">(</span>start <span class="token operator">&lt;</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>values<span class="token punctuation">[</span>indexs<span class="token punctuation">[</span>mid<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">&lt;</span> val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            start <span class="token operator">=</span> mid <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            end <span class="token operator">=</span> mid
        <span class="token punctuation">}</span>
        mid <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span><span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> start
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>start<span class="token punctuation">,</span> mid<span class="token punctuation">,</span> end<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/**
 * 获取最长递增子序列索引
*/</span>
<span class="token keyword">const</span> <span class="token function-variable function">getSequence</span> <span class="token operator">=</span> <span class="token punctuation">(</span>arr<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> len <span class="token operator">=</span> arr<span class="token punctuation">.</span>length
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> arr
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> res<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">const</span> prevIndex<span class="token operator">:</span> <span class="token punctuation">(</span><span class="token builtin">number</span> <span class="token operator">|</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>len<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> value <span class="token operator">=</span> arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>res<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
            <span class="token keyword">continue</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> lastIndex <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">const</span> lastVal <span class="token operator">=</span> arr<span class="token punctuation">[</span>lastIndex<span class="token punctuation">]</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>lastVal <span class="token operator">&lt;</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            prevIndex<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> lastIndex
            res<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span>start<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">half</span><span class="token punctuation">(</span>arr<span class="token punctuation">,</span> res<span class="token punctuation">,</span> value<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>value <span class="token operator">&lt;</span> arr<span class="token punctuation">[</span>res<span class="token punctuation">[</span>start<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                prevIndex<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">[</span>start <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span>
                res<span class="token punctuation">[</span>start<span class="token punctuation">]</span> <span class="token operator">=</span> i
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 最后一个下标，往前追溯</span>
    <span class="token keyword">let</span> i <span class="token operator">=</span> res<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
    <span class="token comment">// 最后一个元素一定是正确的</span>
    <span class="token comment">// 使用倒排的顺序，从最后一个开始回溯</span>
    <span class="token keyword">let</span> last <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">at</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> last
        last <span class="token operator">=</span> prevIndex<span class="token punctuation">[</span>last<span class="token punctuation">]</span>
        i<span class="token operator">--</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> res
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createRenderer</span> <span class="token operator">=</span> <span class="token punctuation">(</span>renderOptions<span class="token operator">:</span> RenderOptions<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>
        insert<span class="token operator">:</span> hostInsert<span class="token punctuation">,</span>
        remove<span class="token operator">:</span> hostRemove<span class="token punctuation">,</span>
        patchProp<span class="token operator">:</span> hostPatchProp<span class="token punctuation">,</span>
        createElement<span class="token operator">:</span> hostCreateElement<span class="token punctuation">,</span>
        createText<span class="token operator">:</span> hostCreateText<span class="token punctuation">,</span>
        setText<span class="token operator">:</span> hostSetText<span class="token punctuation">,</span>
        setElementText<span class="token operator">:</span> hostSetElementText<span class="token punctuation">,</span>
    <span class="token punctuation">}</span> <span class="token operator">=</span> renderOptions
    <span class="token keyword">const</span> <span class="token function-variable function">setupRenderEffect</span> <span class="token operator">=</span> <span class="token punctuation">(</span>instance<span class="token operator">:</span> Instance<span class="token punctuation">,</span> container<span class="token operator">:</span> Element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 使用effect包裹，使reactivity收集依赖和触发更新</span>
        <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> prevTree <span class="token operator">=</span> instance<span class="token punctuation">.</span>subTree
            <span class="token keyword">const</span> subTree <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            instance<span class="token punctuation">.</span>subTree <span class="token operator">=</span> subTree
            <span class="token keyword">if</span><span class="token punctuation">(</span>instance<span class="token punctuation">.</span>isMounted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span>bu<span class="token punctuation">,</span> u<span class="token punctuation">}</span> <span class="token operator">=</span> instance <span class="token comment">// 生命周期</span>
                bu<span class="token operator">?.</span><span class="token function">forEach</span><span class="token punctuation">(</span>fn <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>prevTree<span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
                u<span class="token operator">?.</span><span class="token function">forEach</span><span class="token punctuation">(</span>fn <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">const</span> <span class="token punctuation">{</span>bm<span class="token punctuation">,</span> m<span class="token punctuation">}</span> <span class="token operator">=</span> instance <span class="token comment">// 生命周期</span>
                bm<span class="token operator">?.</span><span class="token function">forEach</span><span class="token punctuation">(</span>fn <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> subTree<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
                instance<span class="token punctuation">.</span>isMounted <span class="token operator">=</span> <span class="token boolean">true</span>
                m<span class="token operator">?.</span><span class="token function">forEach</span><span class="token punctuation">(</span>fn <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 挂载子节点
    */</span>
    <span class="token keyword">const</span> mountChildren <span class="token operator">=</span> <span class="token punctuation">(</span>children<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'children'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> container<span class="token operator">:</span> Element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hostSetElementText</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> children<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNumber</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hostSetElementText</span><span class="token punctuation">(</span>container<span class="token punctuation">,</span> children<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isVNode</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> children<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> i <span class="token keyword">in</span> children<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token function">isNumber</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">createVnode</span><span class="token punctuation">(</span><span class="token constant">TEXT</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token function">String</span><span class="token punctuation">(</span>children<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> children<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 挂载(渲染)元素
    */</span>
    <span class="token keyword">const</span> <span class="token function-variable function">mountElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> container<span class="token operator">:</span> Element<span class="token punctuation">,</span> ancher<span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>type<span class="token punctuation">,</span> props<span class="token punctuation">,</span> children<span class="token punctuation">}</span> <span class="token operator">=</span> vnode
        <span class="token keyword">const</span> el <span class="token operator">=</span> <span class="token function">hostCreateElement</span><span class="token punctuation">(</span><span class="token keyword">type</span> <span class="token class-name"><span class="token keyword">as</span></span> <span class="token builtin">string</span><span class="token punctuation">)</span>
        vnode<span class="token punctuation">.</span>el <span class="token operator">=</span> el
        <span class="token comment">// 属性设置</span>
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>props<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">hostPatchProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> Reflect<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>props<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">mountChildren</span><span class="token punctuation">(</span>children<span class="token punctuation">,</span> el<span class="token punctuation">)</span>
        <span class="token function">hostInsert</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> container<span class="token punctuation">,</span> ancher<span class="token punctuation">)</span>
        
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 比对props
    */</span>
    <span class="token keyword">const</span> patchProps <span class="token operator">=</span> <span class="token punctuation">(</span>oldProps<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'props'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> newProps<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'props'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> el<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'el'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 文本没有可比较属性</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isText</span><span class="token punctuation">(</span>el<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>oldProps <span class="token operator">===</span> newProps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 将新的props和旧的props不相同的属性更新</span>
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>newProps<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> prev <span class="token operator">=</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            <span class="token keyword">const</span> next <span class="token operator">=</span> newProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
            prev <span class="token operator">!==</span> next <span class="token operator">&amp;&amp;</span> <span class="token function">hostPatchProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> key<span class="token punctuation">,</span> prev<span class="token punctuation">,</span> next<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 删除旧的存在，但新的不存在的属性</span>
        Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token operator">!</span><span class="token function">hasOwn</span><span class="token punctuation">(</span>newProps<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>key <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">hostPatchProp</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> key<span class="token punctuation">,</span> oldProps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 卸载子节点
    */</span>
    <span class="token keyword">const</span> unmountChildren <span class="token operator">=</span> <span class="token punctuation">(</span>children<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'children'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">isArray</span><span class="token punctuation">(</span>children<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>child <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">isVNode</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>  <span class="token function">hostRemove</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 全量对比，diff核心
    */</span>
    <span class="token keyword">const</span> patchKeyedChildren <span class="token operator">=</span> <span class="token punctuation">(</span>c1<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'children'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> c2<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'children'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> el<span class="token operator">:</span> Element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token function">isArray</span><span class="token punctuation">(</span>c2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 新旧节点是顺序的情况对比方式</span>
        <span class="token comment">// 1.在不超出新旧元素个数的情况下，从头开始比,直到遇到不相同的节点</span>
        <span class="token comment">// 2.在不超出新旧元素个数的情况下，从尾开始比,直到遇到不相同的节点</span>
        <span class="token comment">// 3.两次比较后，前后的元素是一致的，确定改动范围(具体查看以下注释说明)</span>
        <span class="token keyword">let</span> e1 <span class="token operator">=</span> c1<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token keyword">let</span> e2 <span class="token operator">=</span> c2<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span>
        <span class="token comment">// 从头开始比,直到遇到不相同的节点</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode
            <span class="token keyword">const</span> n2 <span class="token operator">=</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> el<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            i<span class="token operator">++</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 从尾开始比,直到遇到不相同的节点</span>
        <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> n1 <span class="token operator">=</span> c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode
            <span class="token keyword">const</span> n2 <span class="token operator">=</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> el<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            e1<span class="token operator">--</span>
            e2<span class="token operator">--</span>
        <span class="token punctuation">}</span>

         <span class="token comment">/**
         * 对比情况(顺序)示例:
         * A、B、C、D为旧有元素,E、F、G、H为插入元素
         * 
         * 前插情况
         *                 A   B   C  D
         * [E] [F] [G] [H] A   B   C  D
         * i=0,e1=-1,e2=3 =&gt; e1&lt;i&lt;=e2(若只多一个元素，i=e2=0)
         * 
         * 后插情况
         * A  B  C  D
         * A  B  C  D [E] [F] [G] [H]
         * i=4,e1=3,e2=7 =&gt; e1&lt;i&lt;=e2(若只多一个元素，i=e2=0)
         * 
         * 中插情况
         * A  B  C  D
         * A  B  C  [E] [F] [G] [H] D
         * i=3,e1=2,e2=6 =&gt; e1&lt;i&lt;=e2(若只多一个元素，i=e2=0)
         * 
         * 前删情况
         * A   B   C  D
         * C   D
         * i=0,e1=1,e2=-1 =&gt; e2&lt;i&lt;=e1(若只少一个元素，i=e1=0)
         * 
         * 后删情况
         * A   B   C  D
         * A   B
         * i=2,e1=3,e2=1 =&gt; e2&lt;i&lt;=e1(若只少一个元素，i=e1)
         * 
         * 中删情况
         * A   B   C  D
         * A   D
         * i=1,e1=2,e2=0 =&gt; e2&lt;i&lt;=e1(若只少一个元素，i=e1)
         * 
         * 总结:
         * 1. e1&lt;i&lt;=e2,新节点多于旧节点,需新增节点[i,e2]
         * 2. e2&lt;i&lt;=e1,旧节点多余新节点,需删除节点[i,e1]
        */</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">/**
                     * 插入位置参照物
                     * 找参照物就是e2的后一个
                     * 若是后插情况e2+1没有值
                     * 若是前插和中插情况e2+1就是就是插入元素的后一个
                     * 注:插入元素底层调用的浏览器api是insertBefore， 第三个参数为null相当于appendChild
                    */</span>
                    <span class="token keyword">const</span> nextPosi <span class="token operator">=</span> e2 <span class="token operator">+</span> <span class="token number">1</span>
                    <span class="token keyword">const</span> ancher <span class="token operator">=</span> nextPosi <span class="token operator">&lt;</span> c2<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>nextPosi<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span><span class="token punctuation">.</span>el <span class="token operator">:</span> <span class="token keyword">null</span>
                    <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> c2<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">,</span> el<span class="token punctuation">,</span> ancher<span class="token punctuation">)</span>
                    i<span class="token operator">++</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span><span class="token punctuation">(</span>i <span class="token operator">&lt;=</span> e1<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">hostRemove</span><span class="token punctuation">(</span><span class="token punctuation">(</span>c1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span><span class="token punctuation">.</span>el<span class="token punctuation">)</span>
                    i<span class="token operator">++</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">&gt;</span> e1 <span class="token operator">&amp;&amp;</span> i <span class="token operator">&gt;</span> e2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
         * 乱序
         * A   B   C   D   E
         * A   C  [F]  B   [G]   [H]  [I]   E
         * i=1;e1=3,e2=6
         * e1、e2同时大于i说明是乱序(等于不用考虑,不进循环)
        */</span>
        
        
        <span class="token comment">/**
         * 保存新节点不匹配的VNode(的key)和其下标
        */</span>
        <span class="token keyword">const</span> keyToNewIndexMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map<span class="token operator">&lt;</span>VNode<span class="token punctuation">[</span><span class="token string">'key'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token builtin">number</span><span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span> j <span class="token operator">&lt;=</span> e2<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> child <span class="token operator">=</span> c2<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode
            keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>child<span class="token punctuation">.</span>key<span class="token punctuation">,</span> j<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
         * 新节点需要对比VNode个数(元素个数=截至下标-开始下标+1)
        */</span>
        <span class="token keyword">const</span> tobePatched <span class="token operator">=</span> e2 <span class="token operator">-</span> i <span class="token operator">+</span> <span class="token number">1</span>
        <span class="token comment">/**
         * 记录需要对比新元素的状态。
         * 注意真实下标=s2+newIndexToOldMapIndex下标
        */</span>
        <span class="token keyword">const</span> newIndexToOldMapIndex<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token builtin">Array</span></span><span class="token punctuation">(</span>tobePatched<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>

        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> i<span class="token punctuation">;</span> j <span class="token operator">&lt;</span> e1<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> prevChild <span class="token operator">=</span> c1<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode
            <span class="token comment">/**
             * 若能取到值，说明当前旧VNode可以复用，它新的下标就是取到的值
             * 若取不到，则将旧VNode对应的元素删除
            */</span>
            <span class="token keyword">const</span> newIndex <span class="token operator">=</span> keyToNewIndexMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>key<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span>newIndex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">hostRemove</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// +1是为了防止是0(初始状态就是0)</span>
                <span class="token comment">// 不直接设置为一个固定的数(比如1)是为了保存其顺序,可以最小限度的调整顺序</span>
                newIndexToOldMapIndex<span class="token punctuation">[</span>newIndex <span class="token operator">-</span> i<span class="token punctuation">]</span> <span class="token operator">=</span> j <span class="token operator">+</span> <span class="token number">1</span> 
                <span class="token comment">// 递归对比</span>
                <span class="token function">patch</span><span class="token punctuation">(</span>prevChild<span class="token punctuation">,</span> c2<span class="token punctuation">[</span>newIndex<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">,</span> el<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">/**
         * 最长递增子序列索引
        */</span>
        <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token function">getSequence</span><span class="token punctuation">(</span>newIndexToOldMapIndex<span class="token punctuation">)</span>
        <span class="token keyword">let</span> k <span class="token operator">=</span> queue<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span>
        <span class="token comment">// 倒着循环是因为浏览器api是insertBefore会插入到参照物之前</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">let</span> j <span class="token operator">=</span> tobePatched <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> j <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">;</span> j<span class="token operator">--</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 倒着数，第一个新旧VNode相同的下标</span>
            <span class="token keyword">const</span> nextIndex <span class="token operator">=</span> i <span class="token operator">+</span> j
            <span class="token keyword">const</span> nextChild <span class="token operator">=</span> c2<span class="token punctuation">[</span>nextIndex<span class="token punctuation">]</span> <span class="token keyword">as</span> VNode
            <span class="token keyword">const</span> anchor <span class="token operator">=</span> nextIndex <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">&lt;</span> c2<span class="token punctuation">.</span>length <span class="token operator">?</span> <span class="token punctuation">(</span>c2<span class="token punctuation">[</span>nextIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token keyword">as</span> VNode<span class="token punctuation">)</span><span class="token punctuation">.</span>el <span class="token operator">:</span> <span class="token keyword">null</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>newIndexToOldMapIndex<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
                <span class="token comment">// 没有旧的VNode可以复用,需插入元素</span>
                <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> nextChild<span class="token punctuation">,</span> el<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>i <span class="token operator">===</span> queue<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    k<span class="token operator">--</span>
                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token function">hostInsert</span><span class="token punctuation">(</span>nextChild<span class="token punctuation">.</span>el<span class="token punctuation">,</span> el<span class="token punctuation">,</span> anchor<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 对比子节点
    */</span>
    <span class="token keyword">const</span> patchChildren <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token operator">:</span> VNode<span class="token punctuation">,</span> n2<span class="token operator">:</span> VNode<span class="token punctuation">,</span> el<span class="token operator">:</span> VNode<span class="token punctuation">[</span><span class="token string">'el'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> c1 <span class="token operator">=</span> n1<span class="token punctuation">.</span>children
        <span class="token keyword">const</span> c2 <span class="token operator">=</span> n2<span class="token punctuation">.</span>children
        
        <span class="token keyword">const</span> prevShapeFlag <span class="token operator">=</span> n1<span class="token punctuation">.</span>shapeFlag
        <span class="token keyword">const</span> nextShapeFlag <span class="token operator">=</span> n2<span class="token punctuation">.</span>shapeFlag

        <span class="token comment">// 不用考虑children是VNode，如果是VNode会走递归</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>nextShapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>prevShapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 文本和文本</span>
                c1 <span class="token operator">!==</span> c2 <span class="token operator">&amp;&amp;</span> <span class="token function">hostSetElementText</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> c2 <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>prevShapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 数组和文本</span>
                <span class="token function">unmountChildren</span><span class="token punctuation">(</span>c1<span class="token punctuation">)</span>
                <span class="token function">hostSetElementText</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> c2 <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>nextShapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>prevShapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">TEXT_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">// 文本和数组</span>
               <span class="token function">hostSetElementText</span><span class="token punctuation">(</span>el<span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
               <span class="token function">mountChildren</span><span class="token punctuation">(</span>c2<span class="token punctuation">,</span> el <span class="token keyword">as</span> Element<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>prevShapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ARRAY_CHILDREN</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 数组和数组</span>
                <span class="token function">patchKeyedChildren</span><span class="token punctuation">(</span>c1<span class="token punctuation">,</span> c2<span class="token punctuation">,</span> el <span class="token keyword">as</span> Element<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 比对前后元素差异
    */</span>
    <span class="token keyword">const</span> <span class="token function-variable function">patchElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token operator">:</span> VNode<span class="token punctuation">,</span> n2<span class="token operator">:</span> VNode<span class="token punctuation">,</span> container<span class="token operator">:</span> Element<span class="token punctuation">,</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 这里元素是一致的，复用</span>
        <span class="token comment">// 不一致的在patch函数里边直接就被干掉了</span>
        n2<span class="token punctuation">.</span>el <span class="token operator">=</span> n1<span class="token punctuation">.</span>el
        <span class="token keyword">const</span> oldProps <span class="token operator">=</span> n1<span class="token punctuation">.</span>props
        <span class="token keyword">const</span> newProps <span class="token operator">=</span> n2<span class="token punctuation">.</span>props
        <span class="token function">patchProps</span><span class="token punctuation">(</span>oldProps<span class="token punctuation">,</span> newProps<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
        <span class="token function">patchChildren</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> n2<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 处理元素
    */</span>
    <span class="token keyword">const</span> <span class="token function-variable function">processElement</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> n2<span class="token operator">:</span> VNode<span class="token punctuation">,</span> container<span class="token operator">:</span> Element<span class="token punctuation">,</span> ancher<span class="token operator">:</span> Node <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 初始化</span>
            <span class="token function">mountElement</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> ancher<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 更新元素</span>
            <span class="token function">patchElement</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 挂载(渲染)组件
    */</span>
    <span class="token keyword">const</span> <span class="token function-variable function">mountComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span>vNode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> container<span class="token operator">:</span> Element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">createComponentInstance</span><span class="token punctuation">(</span>vNode<span class="token punctuation">)</span>
        vNode<span class="token punctuation">.</span>component <span class="token operator">=</span> instance
        <span class="token function">setupComponent</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span>
        <span class="token function">setupRenderEffect</span><span class="token punctuation">(</span>instance<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 处理组件
    */</span>
   <span class="token keyword">const</span> <span class="token function-variable function">processComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> n2<span class="token operator">:</span> VNode<span class="token punctuation">,</span> container<span class="token operator">:</span> Element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 初始化</span>
            <span class="token function">mountComponent</span><span class="token punctuation">(</span>n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 对比更新</span>
            <span class="token comment">// 我这里简化了不需要走，会在setupRenderEffect立被处理</span>
        <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
   <span class="token comment">/**
     * 处理文本
    */</span>
   <span class="token keyword">const</span> <span class="token function-variable function">processText</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> n2<span class="token operator">:</span> VNode<span class="token punctuation">,</span> container<span class="token operator">:</span> Element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isNil</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            n2<span class="token punctuation">.</span>el <span class="token operator">=</span> <span class="token function">hostCreateText</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>children <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token comment">// 创建文本节点</span>
            <span class="token function">hostInsert</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>el<span class="token punctuation">,</span> container<span class="token punctuation">)</span> <span class="token comment">// 插入到容器中</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 更新时，会在patchChildren里处理</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * 渲染前后比对并渲染.n1为null走挂载流程，反之走更新流程
    */</span>
    <span class="token keyword">const</span> <span class="token function-variable function">patch</span> <span class="token operator">=</span> <span class="token punctuation">(</span>n1<span class="token operator">:</span> VNode <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span> n2<span class="token operator">:</span> VNode<span class="token punctuation">,</span> container<span class="token operator">:</span> Element<span class="token punctuation">,</span> ancher<span class="token operator">:</span> Node <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>n1 <span class="token operator">===</span> n2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 两个节点完全不一样，直接去掉前一个，走挂载流程</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isNil</span><span class="token punctuation">(</span>n1<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token function">isSameVNodeType</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">hostRemove</span><span class="token punctuation">(</span>n1<span class="token punctuation">.</span>el<span class="token punctuation">)</span>
            n1 <span class="token operator">=</span> <span class="token keyword">null</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span>shapeFlag<span class="token punctuation">}</span> <span class="token operator">=</span> n2
        <span class="token keyword">if</span><span class="token punctuation">(</span>n2<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token constant">TEXT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 文本节点</span>
            <span class="token function">processText</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">ELEMENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 元素节点</span>
            <span class="token function">processElement</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">,</span> ancher<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>shapeFlag <span class="token operator">&amp;</span> ShapeFlags<span class="token punctuation">.</span><span class="token constant">COMPONENT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 组件节点</span>
            <span class="token function">processComponent</span><span class="token punctuation">(</span>n1<span class="token punctuation">,</span> n2<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token punctuation">(</span>vnode<span class="token operator">:</span> VNode<span class="token punctuation">,</span> container<span class="token operator">:</span> Element<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初次渲染</span>
        <span class="token function">patch</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> vnode<span class="token punctuation">,</span> container<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        createApp<span class="token operator">:</span> <span class="token function">createAppAPI</span><span class="token punctuation">(</span>render<span class="token punctuation">,</span> renderOptions<span class="token punctuation">)</span><span class="token punctuation">,</span>
        render
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>比对流程总结：
调用<code>patch</code>函数对比节点</p> <ul><li>若前后节点完全一致，则什么也不做</li> <li>若前后节点的类型和<code>key</code>任一不一致，删除第一个节点，走挂载流程</li> <li>根据分类(文本、元素和组件)走不同流程
<ul><li>文本
<ul><li>新增：将文本转换成文本节点插入容器即可</li> <li>更新：无需操作，更新会走元素的子节点对比</li></ul></li> <li>组件
<ul><li>新增：实例化组件然后调用<code>setupRenderEffect</code>渲染</li> <li>更新: 无需操作，<code>setupRenderEffect</code>更新时会对比</li></ul></li> <li>元素
<ul><li>新增：创建元素，添加<code>prop</code>然后插入容器</li> <li>更新: 比对<code>prop</code>,比对子节点
<ul><li>子节点只需考虑文本类型和数组类型，<code>VNode</code>会走<code>setupRenderEffect</code></li> <li>文本-文本直接替换即可</li> <li>文本-数组：清除文本节点，挂载数组节点</li> <li>数组-文本：清除数组节点，挂载文本节点</li> <li><strong>数组-数组</strong>：
<ul><li>从头比对，然后从尾比对，获得标识<code>i</code>和前后节点结尾<code>e1</code>和<code>e2</code></li> <li><code>e1&lt;i&lt;=e2</code>新增节点[i,e2]，<code>e2&lt;i&lt;=e1</code>删除节点[i,e1]</li> <li>对于乱序(乱的区域已由前面确定)，将乱序区域新节点用<code>Map</code>保存。遍历乱序区域，检查旧节点能否在新节点<code>Map</code>中找到，找不到直接删掉就节点,找到了就将记录位置，并用<code>patch</code>递归比对。倒着循环乱序区域，从后往前插入节点(若记录位置中没有，则新建再插入。最长递增子序列的作用是防止多余的元素移动，优化性能)。</li></ul></li></ul></li></ul></li></ul></li></ul> <h4 id="runtime-core导出"><a href="#runtime-core导出" class="header-anchor">#</a> runtime-core导出</h4> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-core/index.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token punctuation">{</span><span class="token keyword">type</span> <span class="token class-name">Component</span><span class="token punctuation">,</span> getCurrentInstance<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./component'</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span> createRenderer <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./renderer'</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span><span class="token keyword">type</span> <span class="token class-name">VNode</span><span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token class-name">ExtraProps</span><span class="token punctuation">,</span> createVnode<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./vnode'</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>onBeforeMount<span class="token punctuation">,</span> onMounted<span class="token punctuation">,</span> onBeforeUpdate<span class="token punctuation">,</span> onUpdated<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./apilifecycle'</span>
</code></pre></div><h3 id="runtime-dom"><a href="#runtime-dom" class="header-anchor">#</a> runtime-dom</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/runtime-dom/index.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span><span class="token keyword">type</span> <span class="token class-name">Component</span><span class="token punctuation">,</span> <span class="token keyword">type</span> <span class="token class-name">ExtraProps</span><span class="token punctuation">,</span> createRenderer<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../runtime-core/index'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> isString <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../shared/utils'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>nodeOps<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./nodeOps'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>patchProp<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./patchProp'</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> renderOptions <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>nodeOps<span class="token punctuation">,</span>
    patchProp
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">type</span> <span class="token class-name">RenderOptions</span> <span class="token operator">=</span> <span class="token keyword">typeof</span> renderOptions
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">createApp</span> <span class="token operator">=</span> <span class="token punctuation">(</span>component<span class="token operator">:</span> Component<span class="token punctuation">,</span> rootProps<span class="token operator">:</span> ExtraProps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>createApp<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">createRenderer</span><span class="token punctuation">(</span>renderOptions<span class="token punctuation">)</span>
    <span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>component<span class="token punctuation">,</span> rootProps<span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>mount<span class="token punctuation">}</span> <span class="token operator">=</span> app
    app<span class="token punctuation">.</span><span class="token function-variable function">mount</span> <span class="token operator">=</span> <span class="token punctuation">(</span>container<span class="token operator">:</span> Element <span class="token operator">|</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">isString</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            container <span class="token operator">=</span> renderOptions<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        container<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token string">''</span>
        <span class="token function">mount</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> app
<span class="token punctuation">}</span>
</code></pre></div><h3 id="测试"><a href="#测试" class="header-anchor">#</a> 测试</h3> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">vim</span> src/index.ts
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./reactivity/reactive'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> 
    createVnode<span class="token punctuation">,</span> 
    getCurrentInstance<span class="token punctuation">,</span>
    onBeforeMount<span class="token punctuation">,</span>
    onMounted<span class="token punctuation">,</span>
    onBeforeUpdate<span class="token punctuation">,</span>
    onUpdated
<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./runtime-core'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>createApp<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./runtime-dom'</span>
<span class="token keyword">const</span> App <span class="token operator">=</span> <span class="token punctuation">{</span>
    props<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'name'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token function">getCurrentInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'instance:'</span><span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>instance<span class="token punctuation">)</span>
        <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            count<span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
            arr<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">onBeforeMount</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onBeforeMount'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">onMounted</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onMounted'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">onBeforeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onBeforeUpdate'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token function">onUpdated</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'onUpdated'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// return () =&gt; createVnode(</span>
        <span class="token comment">//     'div', </span>
        <span class="token comment">//     {</span>
        <span class="token comment">//         style: {'background-color': 'red'},</span>
        <span class="token comment">//         onClick: () =&gt; {</span>
        <span class="token comment">//             state.count++</span>
        <span class="token comment">//             console.log(state.count)</span>
        <span class="token comment">//         }</span>
        <span class="token comment">//     },</span>
        <span class="token comment">//     [</span>
        <span class="token comment">//         'i is fish',</span>
        <span class="token comment">//         createVnode('p', {style: {'color': 'green'}}, [state.count])</span>
        <span class="token comment">//     ]</span>
        <span class="token comment">// )</span>

        <span class="token comment">// return () =&gt; {</span>
        <span class="token comment">//     return state.count % 2 === 0</span>
        <span class="token comment">//     ? createVnode('div', {key: 1, style: {color: 'red'}, onClick: () =&gt; state.count++}, [state.count])</span>
        <span class="token comment">//     : createVnode('div', {key: 1, style: {color: 'green'},  onClick: () =&gt; state.count++},[</span>
        <span class="token comment">//         `count: ${state.count}`,</span>
        <span class="token comment">//         createVnode('p', {}, '测试')</span>
        <span class="token comment">//     ])</span>
        <span class="token comment">// }</span>

        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">createVnode</span><span class="token punctuation">(</span>
            <span class="token string">'div'</span><span class="token punctuation">,</span> 
            <span class="token punctuation">{</span>
                <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    state<span class="token punctuation">.</span>count<span class="token operator">++</span>
                    state<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>state<span class="token punctuation">.</span>count<span class="token punctuation">)</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                style<span class="token operator">:</span> <span class="token punctuation">{</span>
                    padding<span class="token operator">:</span> <span class="token string">'30px'</span><span class="token punctuation">,</span>
                    <span class="token string-property property">'background-color'</span><span class="token operator">:</span> <span class="token string">'grey'</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> 
            <span class="token comment">// new Array(state.count + 1)</span>
            <span class="token comment">// .fill(1)</span>
            <span class="token comment">// .map((_, idx) =&gt; createVnode('p', {key: idx}, idx))</span>
            state<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ele<span class="token punctuation">,</span> idx<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">createVnode</span><span class="token punctuation">(</span><span class="token string">'p'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
                style<span class="token operator">:</span> <span class="token punctuation">{</span>
                    display<span class="token operator">:</span> <span class="token string">'inline-block'</span><span class="token punctuation">,</span>
                    padding<span class="token operator">:</span> <span class="token string">'30px'</span><span class="token punctuation">,</span>
                    <span class="token string-property property">'border'</span><span class="token operator">:</span> <span class="token string">'1px aqua solid'</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
                <span class="token function-variable function">onClick</span><span class="token operator">:</span> <span class="token punctuation">(</span>ev<span class="token operator">:</span> Event<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                    ev<span class="token punctuation">.</span><span class="token function">stopPropagation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    state<span class="token punctuation">.</span>arr <span class="token operator">=</span> state<span class="token punctuation">.</span>arr<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>element <span class="token operator">=&gt;</span> element <span class="token operator">!==</span> ele<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> ele<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">,</span> <span class="token punctuation">{</span>name<span class="token operator">:</span> <span class="token string">'root'</span><span class="token punctuation">,</span> count<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">5/4/2024, 5:21:51 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/docs/THREE笔记.html" class="prev">
        THREE笔记
      </a></span> <span class="next"><a href="/docs/前端渲染大量数据方案.html">
        前端渲染大量数据方案
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/docs/assets/js/app.e9bf7062.js" defer></script><script src="/docs/assets/js/2.21081ec6.js" defer></script><script src="/docs/assets/js/1.d6a5e65b.js" defer></script><script src="/docs/assets/js/85.b52f4b36.js" defer></script>
  </body>
</html>
